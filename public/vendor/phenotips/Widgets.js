var PhenoTips=(function(b){var a=b.widgets=b.widgets||{};if(typeof XWiki.widgets.XList=="undefined"){if(typeof console!="undefined"&&typeof console.warn=="function"){console.warn("[Suggest widget] Required class missing: XWiki.widgets.XList")}}else{a.XList=XWiki.widgets.XList;a.XListItem=XWiki.widgets.XListItem;a.Suggest=Class.create({options:{minchars:1,method:"get",varname:"input",matchVarname:"id",className:"ajaxsuggest",timeout:30000,delay:500,offsety:0,shownoresults:true,noresults:"No results!",maxheight:250,cache:false,seps:"",icon:null,resultsParameter:"results",resultId:"id",resultValue:"value",resultInfo:"info",resultCategory:"category",resultAltName:"",resultIcon:"icon",resultHint:"hint",tooltip:false,markFreeText:false,highlight:true,fadeOnClear:false,enableHideButton:true,insertBeforeSuggestions:null,displayId:false,forceFirstId:false,displayValue:false,displayValueText:"Value :",align:"left",unifiedLoader:false,loaderNode:null,filterFunc:null,json:true},sInput:"",nInputChars:0,aSuggestions:[],iHighlighted:null,isActive:false,suggestionSelected:false,lastSubmitted:"",initialize:function(c,d){if(!c){return false}this.setInputField(c);this.options=Object.extend(Object.clone(this.options),d||{});if(typeof this.options.sources=="object"&&this.options.sources.length>1){this.sources=this.options.sources}else{this.sources=this.options}this.sources=[this.sources].flatten().compact();if(!$(this.options.parentContainer)){this.options.parentContainer=$(document.body)}if(this.options.seps){this.seps=this.options.seps}else{this.seps=""}this.latestRequest=0;this.addInputObservers()},setInputField:function(c){if(this.fld){this.fld.stopObserving()}this.fld=$(c);this.fld._suggestWidget=this;this.fld.observe("keyup",this.onKeyUp.bindAsEventListener(this));if(Prototype.Browser.IE||Prototype.Browser.WebKit){this.fld.observe("keydown",this.onKeyPress.bindAsEventListener(this))}else{this.fld.observe("keypress",this.onKeyPress.bindAsEventListener(this))}this.fld.observe("paste",this.onPaste.bindAsEventListener(this));this.fld.setAttribute("autocomplete","off");this.fld.observe("blur",function(d){this.latestRequest++;this.fld.removeClassName("loading")}.bind(this))},addInputObservers:function(){$(document).observe("ms:suggest:containerCreated",this.onSuggestCreated.bindAsEventListener(this));$(document).observe("ms:suggest:selected",this.onDataSubmitted.bindAsEventListener(this));this.fld.observe("blur",this.onInputBlurred.bindAsEventListener(this))},onKeyUp:function(f){var d=f.keyCode;switch(d){case Event.KEY_RETURN:case Event.KEY_TAB:case Event.KEY_ESC:case Event.KEY_UP:case Event.KEY_DOWN:break;default:if(this.seps){var e=-1;for(var c=0;c<this.seps.length;c++){if(this.fld.value.lastIndexOf(this.seps.charAt(c))>e){e=this.fld.value.lastIndexOf(this.seps.charAt(c))}}if(e==-1){this.getSuggestions(this.fld.value)}else{this.getSuggestions(this.fld.value.substring(e+1))}}else{this.getSuggestions(this.fld.value)}}},onPaste:function(c){setTimeout(function(){this.onKeyUp({keyCode:null})}.bind(this),0)},onKeyPress:function(d){if(!$(this.isActive)){if(d.keyCode==Event.KEY_RETURN){Event.stop(d)}return}var c=d.keyCode;switch(c){case Event.KEY_RETURN:this.setHighlightedValue();Event.stop(d);break;case Event.KEY_TAB:this.clearSuggestions();break;case Event.KEY_ESC:this.clearSuggestions();Event.stop(d);break;case Event.KEY_UP:this.changeHighlight(c);Event.stop(d);break;case Event.KEY_DOWN:this.changeHighlight(c);Event.stop(d);break;default:break}},onSuggestCreated:function(c){this.suggestionSelected=false;var d=this;c.memo.container&&$(c.memo.container).observe("mousedown",function(e){d.suggestionSelected=true})},onDataSubmitted:function(c){this.suggestionSelected=true;this.lastSubmitted=c.memo.value||this.fld.value.strip()},onInputBlurred:function(c){if(this.suggestionSelected||this.fld.value.length<this.options.minchars){this.suggestionSelected=false;return}var e=this.fld.value.strip();var d=this.submitDropdownMatch(e);if(!d){if(e==this.lastSubmitted&&e.length>1){return}clearTimeout(this.ajID);this.submitAjaxSearchMatch(e,++this.latestRequest)}},submitDropdownMatch:function(f){if(typeof this.aSuggestions=="undefined"||this.aSuggestions.length<=0){return false}var c=f.toUpperCase();for(var d=0;d<this.aSuggestions.length;d++){var e=this.aSuggestions[d];if(e.value.strip().toUpperCase()===c||e.id.strip().toUpperCase()===c){this.acceptEntry(e,e.value,e.value);return true}}return false},submitAjaxSearchMatch:function(g,h){this.lastSubmitted=this.fld.value.strip();if(h<this.latestRequest||this.fld.value.strip().length<this.options.minchars){return}for(var e=0;e<this.sources.length;e++){var f=this.sources[e];if(!f.matchScript){continue}var d=f.matchScript+f.matchVarname+"="+encodeURIComponent(g);var l=f.method||"get";var k={};if(f.json){k.Accept="application/json"}else{k.Accept="application/xml"}var c=new Ajax.Request(d,{method:l,requestHeaders:k,onCreate:function(){this.fld.addClassName("loading")}.bind(this),onSuccess:this.setSearchData.bindAsEventListener(this,f,g,h),onComplete:function(){if(h<this.latestRequest){return}this.fld.removeClassName("loading")}.bind(this)})}},setSearchData:function(e,k,h,l){if(l<this.latestRequest){return false}var d,c,g;if(k&&k.json){var d=e.responseJSON;if(!d){return false}c=function(m,n){return m&&(m[n+"_translated"]||m[n])||""};g=function(m,n){return new Array(m&&(m[n+"_translated"]||m[n])||"").flatten()}}else{var d=e.responseXML;if(!d){return false}c=function(o,m){var n=o&&Element.down(o,m);return n&&n.firstChild&&n.firstChild.nodeValue||""};g=function(o,n){var m=[];if(o){Element.select(o,n).each(function(p){var q=p.firstChild&&p.firstChild.nodeValue;if(q){m.push(q)}})}return m}}var f={suggest:this,id:this._processId(c(d,k.resultId||this.options.resultId),k.forceFirstId||this.options.forceFirstId),value:c(d,k.resultValue||this.options.resultValue),info:this.generateResultInfo(d,g),icon:c(d,k.resultIcon||this.options.resultIcon),category:this.generateResultCategory(d,g)};this.acceptTypedInput(f,f.value)},acceptTypedInput:function(e,f,c){var d=Event.fire(this.fld,"ms:suggest:selected",e);if(!d.stopped){if(!c){this.fld.value=f||this.fld.defaultValue||""}if(typeof(this.options.callback)=="function"){this.options.callback(e)}}},getSuggestions:function(g){g=g.strip().toLowerCase();if(g==this.sInput&&g.length>1){return false}if(g.length==0){this.sInput="";this.clearSuggestions();return false}if(g.length<this.options.minchars){this.sInput="";return false}if(g.length>this.nInputChars&&this.aSuggestions.length&&this.options.cache){var c=[];for(var d=0;d<this.aSuggestions.length;d++){if(this.aSuggestions[d].value.substr(0,g.length).toLowerCase()==g){c.push(this.aSuggestions[d])}}this.sInput=g;this.nInputChars=g.length;this.aSuggestions=c;this.createList(this.aSuggestions);return false}else{this.sInput=g;this.nInputChars=g.length;this.prepareContainer();this.latestRequest++;var f=this;var e=this.latestRequest;clearTimeout(this.ajID);this.ajID=setTimeout(function(){f.doAjaxRequests(e)},this.options.delay)}return false},doAjaxRequests:function(h){if(h<this.latestRequest){return}if(this.fld.value.length<this.options.minchars){return}for(var e=0;e<this.sources.length;e++){var g=this.sources[e];var f=this.fld.value.strip();var d=g.script+g.varname+"="+encodeURIComponent(f);var l=g.method||"get";var k={};if(g.json){k.Accept="application/json"}else{k.Accept="application/xml"}var c=new Ajax.Request(d,{method:l,requestHeaders:k,onCreate:function(){this.fld.addClassName("loading")}.bind(this),onSuccess:this.setSuggestions.bindAsEventListener(this,g,h),onFailure:function(m){alert("Failed to retrieve suggestions : "+m.statusText)},onComplete:function(){if(h<this.latestRequest){return}this.fld.removeClassName("loading")}.bind(this)})}},setSuggestions:function(c,d,e){if(e<this.latestRequest){return}this.aSuggestions=this.getSuggestionList(c,d);this.createList(this.aSuggestions,d)},getSuggestionList:function(u,c){var r=[];if(c&&c.json){var o=u.responseJSON;if(!o){return false}var q=o[c.resultsParameter||this.options.resultsParameter];var h=function(k,w){return k&&(k[w+"_translated"]||k[w])||""};var v=function(k,w){return new Array(k&&(k[w+"_translated"]||k[w])||"").flatten()}}else{var t=u.responseXML;if(!t){return false}var q=t.getElementsByTagName((c&&c.resultsParameter)||this.options.resultsParameter);var h=function(x,k){var w=x&&Element.down(x,k);return w&&w.firstChild&&w.firstChild.nodeValue||""};var v=function(x,w){var k=new Array();if(x){Element.select(x,w).each(function(y){var z=y.firstChild&&y.firstChild.nodeValue;if(z){k.push(z)}})}return k}}for(var p=0;p<q.length;p++){var l=this.generateResultInfo(q[p],v);var g=this.generateResultCategory(q[p],v);if(this.options.resultAltName){var e="";var d=h(q[p],c.resultValue||this.options.resultValue);var f=v(q[p],c.resultAltName||this.options.resultAltName);var s=this.computeSimilarity(d,this.sInput);for(var n=0;n<f.length;++n){var m=this.computeSimilarity(f[n],this.sInput);if(m>s){e=f[n];s=m}}}r.push({id:this._processId(h(q[p],c.resultId||this.options.resultId),c.forceFirstId||this.options.forceFirstId),value:h(q[p],c.resultValue||this.options.resultValue),icon:h(q[p],c.resultIcon||this.options.resultIcon),altName:e,info:l,category:g})}return r},_processId:function(c,d){if(c.constructor===Array&&d){return c.length>0?c[0]:""}else{return c}},generateResultInfo:function(p,h){var e=new Element("dl");var l=this;for(var n in this.options.resultInfo){var o=this.options.resultInfo[n];var k=n.strip().toLowerCase().replace(/[^a-z0-9 ]/gi,"").replace(/\s+/gi,"-");var f="";if(o.collapsed){f="collapsed"}var m=o.processor;if(o.extern){var d=new Element("a").update(n);d._processingFunction=m;e.insert({bottom:new Element("dt",{"class":f+" "+k}).insert({bottom:d})});d._processingFunction.call(this,d);continue}var g=o.selector;if(!g){continue}var c=null;h(p,g).each(function(r){var s=r||"";if(typeof(m)=="function"){s=m(s)}if(s==""){return}if(!c){var q=new Element("a",{"class":"expand-tool"}).update(l._getExpandCollapseTriggerSymbol(o.collapsed));e.insert({bottom:new Element("dt",{"class":f}).insert({top:q}).insert({bottom:n})});c=new Element("dd",{"class":"expandable"});e.insert({bottom:c});q.observe("click",function(t){t.stop();q.up().toggleClassName("collapsed");q.update(l._getExpandCollapseTriggerSymbol(q.up().hasClassName("collapsed")))}.bindAsEventListener(this))}c.insert({bottom:new Element("div").update(s)})})}if(!e.hasChildNodes()){e=""}return e},generateResultCategory:function(c,e){if(this.options.resultCategory){var d=new Element("span",{"class":"hidden term-category"});e(c,this.options.resultCategory).each(function(f){d.insert(new Element("input",{type:"hidden",value:f}))})}if(!this.options.resultCategory||!d.hasChildNodes()){d=""}return d},_getExpandCollapseTriggerSymbol:function(c){if(c){return"&#x25B8;"}return"&#x25BE;"},computeSimilarity:function(l,h){var e;var g=0;var k=2;var q=l;var f=q.length;var p=h;var c=p.length;var o=new Array();for(i=0;i<c;i++){o[i]=new Array();e=(q.charAt(i)==p.charAt(0))?1:-1;if(i==0){o[0][0]=Math.max(0,-k,e)}else{o[i][0]=Math.max(0,o[i-1][0]-k,e)}if(o[i][0]>g){g=o[i][0]}}for(j=0;j<f;j++){e=(q.charAt(0)==p.charAt(j))?1:-1;if(j==0){o[0][0]=Math.max(0,-k,e)}else{o[0][j]=Math.max(0,o[0][j-1]-k,e)}if(o[0][j]>g){g=o[0][j]}}for(i=1;i<c;i++){for(j=1;j<f;j++){e=(q.charAt(i)==p.charAt(j))?1:-1;o[i][j]=Math.max(0,o[i-1][j]-k,o[i][j-1]-k,o[i-1][j-1]+e);if(o[i][j]>g){g=o[i][j]}}}return g},prepareContainer:function(){var n=$(this.options.parentContainer).down(".suggestItems");if(n&&n.__targetField!=this.fld){if(n.__targetField){n.__targetField._suggest.clearSuggestions()}else{n.remove()}n=false}if(!n){var e=new Element("div",{"class":"suggestItems "+this.options.className});var m=$(this.options.parentContainer).tagName.toLowerCase()=="body"?this.fld.cumulativeOffset():this.fld.positionedOffset();var p=this.options.width?this.options.width:(this.fld.offsetWidth-2);if(this.options.align=="left"){e.style.left=m.left+"px"}else{if(this.options.align=="center"){e.style.left=m.left+(this.fld.getWidth()-p-2)/2+"px"}else{e.style.left=(m.left-p+this.fld.offsetWidth-2)+"px"}}e.style.top=(m.top+this.fld.offsetHeight+this.options.offsety)+"px";e.style.width=p+"px";var c=this;e.onmouseover=function(){c.killTimeout()};e.onmouseout=function(){c.resetTimeout()};this.resultContainer=new Element("div",{"class":"resultContainer"});e.appendChild(this.resultContainer);$(this.options.parentContainer).insert(e);this.container=e;if(this.options.insertBeforeSuggestions){this.resultContainer.insert(this.options.insertBeforeSuggestions)}document.fire("ms:suggest:containerCreated",{container:this.container,suggest:this})}if(this.sources.length>1){for(var g=0;g<this.sources.length;g++){var d=this.sources[g];d.id=g;if(this.resultContainer.down(".results"+d.id)){if(this.resultContainer.down(".results"+d.id).down("ul")){this.resultContainer.down(".results"+d.id).down("ul").remove()}if(!this.options.unifiedLoader){this.resultContainer.down(".results"+d.id).down(".sourceContent").addClassName("loading")}else{(this.options.loaderNode||this.fld).addClassName("loading");this.resultContainer.down(".results"+d.id).addClassName("hidden loading")}}else{var q=new Element("div",{"class":"results results"+d.id}),o=new Element("div",{"class":"sourceName"});if(this.options.unifiedLoader){q.addClassName("hidden loading")}if(typeof d.icon!="undefined"){var l=new Image();l.onload=function(){this.sourceHeader.setStyle({backgroundImage:"url("+this.iconImage.src+")"});this.sourceHeader.setStyle({textIndent:(this.iconImage.width+6)+"px"})}.bind({sourceHeader:o,iconImage:l});l.src=d.icon}o.insert(d.name);q.insert(o);var f="sourceContent "+(this.options.unifiedLoader?"":"loading");q.insert(new Element("div",{"class":f}));if(typeof d.before!=="undefined"){this.resultContainer.insert(d.before)}this.resultContainer.insert(q);if(typeof d.after!=="undefined"){this.resultContainer.insert(d.after)}}}}else{if(this.resultContainer.down("ul")){this.resultContainer.down("ul").remove()}}var k=this.container.fire("ms:suggest:containerPrepared",{container:this.container,suggest:this});this.container.__targetField=this.fld;if(this.options.enableHideButton&&!this.container.down(".hide-button")){var h=new Element("span",{"class":"hide-button"}).update("hide suggestions");h.observe("click",this.clearSuggestions.bindAsEventListener(this));this.container.insert({top:new Element("div",{"class":"hide-button-wrapper"}).update(h)});h=new Element("span",{"class":"hide-button"}).update("hide suggestions");h.observe("click",this.clearSuggestions.bindAsEventListener(this));this.container.insert({bottom:new Element("div",{"class":"hide-button-wrapper"}).update(h)})}return this.container},createList:function(c,e){this.isActive=true;var f=this;this.killTimeout();this.clearHighlight();if(this.sources.length>1){var g=this.resultContainer.down(".results"+e.id);if(c.length>0||this.options.shownoresults){g.down(".sourceContent").removeClassName("loading");this.resultContainer.down(".results"+e.id).removeClassName("hidden loading")}if(this.options.unifiedLoader&&!this.resultContainer.down("loading")){(this.options.loaderNode||this.fld).removeClassName("loading")}}else{var g=this.resultContainer}if(c.length==0&&!this.options.shownoresults){return false}if(g.down("ul")){g.down("ul").remove()}var d=this.createListElement(c,f);g.appendChild(d);Event.fire(document,"xwiki:dom:updated",{elements:[d]});this.suggest=g;var f=this;if(this.options.timeout>0){this.toID=setTimeout(function(){f.clearSuggestions()},this.options.timeout)}this.highlightFirst()},createListElement:function(f,c){var h=new b.widgets.XList([],{icon:this.options.icon,classes:"suggestList",eventListeners:{click:function(){c.setHighlightedValue();return false},mouseover:function(){c.setHighlight(this.getElement())}}});for(var e=0,g=f.length;e<g;e++){if(!this.options.filterFunc||this.options.filterFunc(f[e])){h.addItem(this.generateListItem(f[e]))}}if(f.length==0){h.addItem(new b.widgets.XListItem(this.options.noresults,{classes:"noSuggestion",noHighlight:true}))}if(this.fld.hasClassName("accept-value")){var m=this.fld.value.replace(/[^a-z0-9_]+/gi,"_");var k=this.fld.next('input[name="_category"]');var n=k&&k.value.split(",")||[];var d=new Element("div",{"class":"hidden term-category"});var l=this.fld.name+"__"+m+"__category";n.each(function(o){if(o){d.insert(new Element("input",{type:"hidden",name:l,value:o}))}});h.addItem(this.generateListItem({id:this.fld.value,value:this.fld.value,category:d,custom:true,info:new Element("div",{"class":"hint"}).update("(your text, not a standard term)")},"custom-value",true))}return h.getElement()},generateListItem:function(k,d,l){var f=new Element("div",{"class":"tooltip-"+this.options.tooltip});if(k.icon){f.insert(new Element("img",{src:k.icon,"class":"icon"}))}if(this.options.displayId){f.insert(new Element("span",{"class":"suggestId"}).update(k.id.escapeHTML()))}f.insert(new Element("span",{"class":"suggestValue"}).update(k.value.escapeHTML()));if(this.options.tooltip&&!l){var e=new Element("span",{"class":"fa fa-info-circle xHelpButton "+this.options.tooltip,title:k.id,"data-source":this.fld.id});e.observe("click",function(m){m.stop()});f.insert(" ").insert(e)}var h=new Element("div",{"class":"suggestInfo"}).update(k.info);f.insert(h);if(k.altName){h.insert({top:new Element("span",{"class":"matching-alternative-name"}).update(k.altName.escapeHTML())})}var c=new Element("div").insert(new Element("span",{"class":"suggestId"}).update(k.id.escapeHTML())).insert(new Element("span",{"class":"suggestValue"}).update(k.value.escapeHTML())).insert(new Element("div",{"class":"suggestCategory"}).update(k.category));k.custom&&c.insert(new Element("div",{"class":"isCustom"}).update(k.custom));c.store("itemData",k);var g=new b.widgets.XListItem(f,{containerClasses:"suggestItem "+(d||""),value:c,noHighlight:true});Event.fire(this.fld,"ms:suggest:suggestionCreated",{element:g.getElement(),suggest:this});return g},emphasizeMatches:function(l,n){var c=n,k=l.split(" ").uniq().compact(),d=0,g={};for(var e=0,o=k.length;e<o;e++){var h=c.toLowerCase().indexOf(k[e].toLowerCase());while(h>=0){var f=c.substring(h,h+k[e].length),m="";k[e].length.times(function(){m+=" "});g[h]=f;c=c.substring(0,h)+m+c.substring(h+k[e].length);h=c.toLowerCase().indexOf(k[e].toLowerCase())}}Object.keys(g).sortBy(function(p){return parseInt(p)}).each(function(p){var q=c.substring(0,parseInt(p)+d);var r=c.substring(parseInt(p)+g[p].length+d);c=q+"<em>"+g[p]+"</em>"+r;d+=9});return c},changeHighlight:function(c){var f=this.resultContainer;if(!f){return false}var g,d;if(this.iHighlighted){if(c==Event.KEY_DOWN){d=this.iHighlighted.next();if(!d&&this.iHighlighted.up("div.results")){var e=this.iHighlighted.up("div.results").next();while(e&&!d){d=e.down("li");e=e.next()}}if(!d){d=f.down("li")}}else{if(c==Event.KEY_UP){d=this.iHighlighted.previous();if(!d&&this.iHighlighted.up("div.results")){var e=this.iHighlighted.up("div.results").previous();while(e&&!d){d=e.down("li:last-child");e=e.previous()}}if(!d){d=f.select("ul")[f.select("ul").length-1].down("li:last-child")}}}}else{if(c==Event.KEY_DOWN){if(f.down("div.results")){d=f.down("div.results").down("li")}else{d=f.down("li")}}else{if(c==Event.KEY_UP){if(f.select("li")>0){d=f.select("li")[f.select("li").length-1]}}}}if(d){this.setHighlight(d)}},setHighlight:function(c){if(this.iHighlighted){this.clearHighlight()}c.addClassName("xhighlight");this.iHighlighted=c;this.killTimeout()},clearHighlight:function(){if(this.iHighlighted){this.iHighlighted.removeClassName("xhighlight");delete this.iHighlighted}},highlightFirst:function(){if(this.suggest&&this.suggest.down("ul")){var c=this.suggest.down("ul").down("li");if(c){this.setHighlight(c)}}},hasActiveSelection:function(){return this.iHighlighted},setHighlightedValue:function(){if(this.iHighlighted&&!this.iHighlighted.hasClassName("noSuggestion")){var e,c;if(this.sInput==""&&this.fld.value==""){e=c=this.iHighlighted.down(".suggestValue").innerHTML}else{if(this.seps){var f=-1;for(var d=0;d<this.seps.length;d++){if(this.fld.value.lastIndexOf(this.seps.charAt(d))>f){f=this.fld.value.lastIndexOf(this.seps.charAt(d))}}if(f==-1){e=c=this.iHighlighted.down(".suggestValue").innerHTML}else{c=this.fld.value.substring(0,f+1)+this.iHighlighted.down(".suggestValue").innerHTML;e=c.substring(f+1)}}else{e=c=this.iHighlighted.down(".suggestValue").innerHTML}}var h=this.iHighlighted.down(".value div").retrieve("itemData");var g={suggest:this,id:h.id||this.iHighlighted.down(".suggestId").innerHTML,value:h.value||this.iHighlighted.down(".suggestValue").innerHTML,info:h.info||this.iHighlighted.down(".suggestInfo").innerHTML,icon:h.icon||(this.iHighlighted.down("img.icon")?this.iHighlighted.down("img.icon").src:""),category:this.iHighlighted.down(".suggestCategory").innerHTML,custom:h.custom||false};this.acceptEntry(g,e,c)}},acceptEntry:function(k,g,f,e){var h=Event.fire(this.fld,"ms:suggest:selected",k);if(!h.stopped){if(!e){this.sInput=g;this.fld.value=f||this.fld.defaultValue||"";this.fld.focus();this.clearSuggestions()}if(typeof(this.options.callback)=="function"){this.options.callback(k)}if(this.fld.id.indexOf("_suggest")>0){var d=this.fld.id.substring(0,this.fld.id.indexOf("_suggest"));var c=$(d);if(c){c.value=info}}}},killTimeout:function(){clearTimeout(this.toID)},resetTimeout:function(){clearTimeout(this.toID);var c=this;this.toID=setTimeout(function(){c.clearSuggestions()},1000000)},clearSuggestions:function(){this.killTimeout();this.isActive=false;var c=$(this.container);var e=this;if(c&&c.parentNode){if(this.options.fadeOnClear){var d=new Effect.Fade(c,{duration:"0.25",afterFinish:function(){if($(e.container)){$(e.container).remove()}}})}else{$(this.container).remove()}document.fire("ms:suggest:clearSuggestions",{suggest:this})}}})}return b})(PhenoTips||{});var PhenoTips=(function(b){var a=b.widgets=b.widgets||{};a.SuggestPicker=Class.create({options:{showKey:true,showTooltip:false,showDeleteTool:true,enableSort:true,showClearTool:true,inputType:"hidden",listInsertionElt:null,listInsertionPosition:"after",predefinedEntries:null,acceptFreeText:false},initialize:function(d,g,c,f){this.options=Object.extend(Object.clone(this.options),c||{});this.serializedDataInput=f;this.input=d;this.suggest=g;this.inputName=this.input.name;if(!this.options.acceptFreeText){this.input.name=this.input.name+"__suggested"}else{this.input.addClassName("accept-value")}this.suggest.options.callback=this.acceptSuggestion.bind(this);this.list=new Element("ul",{"class":"accepted-suggestions"});var h;if(this.options.listInsertionElt){if(typeof(this.options.listInsertionElt)=="string"){h=this.input.up().down(this.options.listInsertionElt)}else{h=this.options.listInsertionElt}}if(!h){h=this.input}var e={};e[this.options.listInsertionPosition]=this.list;h.insert(e);this.predefinedEntries=this.options.predefinedEntries?$(this.options.predefinedEntries):null;if(this.options.showClearTool){this.clearTool=new Element("span",{"class":"clear-tool delete-tool invisible",title:"Clear the list of selected suggestions"}).update("Delete all &#x2716;");this.clearTool.observe("click",this.clearAcceptedList.bindAsEventListener(this));this.list.insert({after:this.clearTool})}if(typeof(this.options.onItemAdded)=="function"){this.onItemAdded=this.options.onItemAdded}},acceptAddItem:function(f,e){var c='input[id="'+this.getInputId(f,e).replace(/[^a-zA-Z0-9_-]/g,"\\$&")+'"]';var d=this.predefinedEntries?this.predefinedEntries.down(c):this.list?this.list.down(c):$(this.getInputId(f,e));if(d){d.checked=true;Event.fire(d,"suggest:change");this.synchronizeSelection(d);return false}return true},ensureVisible:function(c,d){if(this.silent||(!d&&this.options.silent)||c.up(".hidden")){return}var e=c.up(".collapsed:not(.force-collapse)");while(e){e.removeClassName("collapsed");if(e.down(".expand-tool")){e.down(".expand-tool").update("â–¼")}e=e.up(".collapsed:not(.force-collapse)")}if(c.viewportOffset().top>this.input.viewportOffset().top){if(c.viewportOffset().top>document.viewport.getHeight()){if(c.viewportOffset().top-this.input.viewportOffset().top<document.viewport.getHeight()){this.input.scrollTo()}else{c.scrollTo()}}}else{if(c.cumulativeOffset().top<document.viewport.getScrollOffsets().top){c.scrollTo()}}},acceptSuggestion:function(c){this.input.value=this.input.defaultValue||"";if(this.acceptAddItem(c.id||c.value,c.negative)){this.addItem(c.id||c.value,c.value,c.info,c.category,c.custom)}return false},addItem:function(o,n,g,f,d){if(!o){return}var e=this.getInputId(o);var c=new Element("li");var p=new Element("label",{"class":"accepted-suggestion","for":e});var k={type:this.options.inputType,name:this.inputName,id:e,value:o};if(this.options.inputType=="checkbox"){k.checked=true}p.insert({bottom:new Element("input",k)});if(this.options.showKey&&!d){p.insert({bottom:new Element("span",{"class":"key"}).update("["+o.escapeHTML()+"]")});p.insert({bottom:new Element("span",{"class":"sep"}).update(" ")})}p.insert({bottom:new Element("span",{"class":"value"}).update(n.escapeHTML())});c.insert(p);if(this.suggest.options.tooltip){var h=this.suggest.options.markFreeText&&d?new Element("span",{"class":"fa fa-fw fa-exclamation-triangle",title:this.suggest.options.freeTextTooltipHint||""}):new Element("span",{"class":"fa fa-info-circle xHelpButton "+this.suggest.options.tooltip,title:o,"data-source":this.input&&this.input.id||""});c.insert(h)}if(f&&f!=""){c.insert(f)}if(this.options.showDeleteTool){var m=new Element("span",{"class":"delete-tool",title:"Delete this term"}).update("&#x2716;");m.observe("click",this.removeItem.bindAsEventListener(this));c.appendChild(m)}if(this.options.showTooltip&&g){c.appendChild(new Element("div",{"class":"tooltip"}).update(g));c.select(".expand-tool").invoke("observe","click",function(q){q.stop()})}this.list.insert(c);var l=this.list?this.list.down('input[id="'+e.replace(/[^a-zA-Z0-9_-]/g,"\\$&")+'"]'):$(e);this.synchronizeSelection(l);l.observe("change",this.synchronizeSelection.bind(this,l));this.updateListTools();Event.fire(document,"xwiki:dom:updated",{elements:[c]});this.onItemAdded(l);return l},onItemAdded:function(c){},removeItem:function(d){var c=d.findElement&&d.findElement("li")||d;this.synchronizeSelection({value:(c.down("input[type=checkbox]")||c.down("input")).value,checked:false});console.log(c);c.remove();this.notifySelectionChange(c);this.input.value=this.input.defaultValue||"";this.updateListTools()},clearAcceptedList:function(){var c=this;this.list.select("li").each(function(d){c.removeItem(d)})},updateListTools:function(){if(this.clearTool){if(this.list.select("li .accepted-suggestion").length>0){this.clearTool.removeClassName("invisible")}else{this.clearTool.addClassName("invisible")}}if(this.options.enableSort&&this.list.select("li .accepted-suggestion").length>0&&typeof(Sortable)!="undefined"){Sortable.create(this.list)}if(this.serializedDataInput){var c="";this.list.select("li .accepted-suggestion input[type=checkbox]").each(function(d){c+=d.value+"|"});this.serializedDataInput.value=c}},getInputId:function(d,c){return(c?this.inputName.replace(/(_\d+)_/,"$1_negative_"):this.inputName)+"_"+d},synchronizeSelection:function(f){var g=(typeof(f.up)=="function")&&f.up("li");if(g){if(this.input.hasClassName("generateYesNo")&&!f.up(".yes-no-picker")){Element.select(g,'input[name="fieldName"][type="hidden"]').each(function(o){var m=o.up("li").down('input[type="checkbox"]');var l=m.name;m.id=m.id.replace(m.name,o.value);m.name=o.value;m.up("label").addClassName(o.className);m.up("label").htmlFor=m.id;o.value=l;if(o.up(".term-category")){o.up(".term-category").insert({before:o})}});var e=this.input.name.replace(/__suggested$/,"");var c=this.input.name.replace(/(_\d+)_/,"$1_negative_").replace(/__suggested$/,"");var h=f.value;var k=g.down(".value").firstChild.nodeValue;var d=YesNoPicker.generatePickerElement([{type:"na",selected:!isValueSelected(e,h)&&!isValueSelected(c,h)},{type:"yes",name:e,selected:isValueSelected(e,h)},{type:"no",name:c,selected:isValueSelected(c,h)}],h,k,true,f.next());f.insert({before:d});f.hide();f.name="";f.id="";f.value="";enableHighlightChecked(d.down(".yes input"));enableHighlightChecked(d.down(".no input"))}}if(g){this.notifySelectionChange(g)}},notifySelectionChange:function(c){if(!c.__categoryArray){c.__categoryArray=[];Element.select(c,".term-category input[type=hidden]").each(function(d){c.__categoryArray.push(d.value)})}Event.fire(this.input,"xwiki:form:field-value-changed");Event.fire(document,"custom:selection:changed",{categories:c.__categoryArray,trigger:this.input,fieldName:this.inputName,customElement:c})}});return b}(PhenoTips||{}));var PhenoTips=(function(b){var a=b.widgets=b.widgets||{};a.ModalPopup=Class.create({options:{idPrefix:"modal-popup-",title:"",displayCloseButton:true,screenColor:"",borderColor:"",titleColor:"",backgroundColor:"",screenOpacity:"0.5",verticalPosition:"center",horizontalPosition:"center",resetPositionOnShow:true,removeOnClose:false,onClose:Prototype.emptyFunction},initialize:function(e,c,d){this.shortcuts={show:{method:this.showDialog,keys:[]},close:{method:this.closeDialog,keys:["Esc"]}},this.content=e||"Hello world!";this.shortcuts=Object.extend(Object.clone(this.shortcuts),c||{});this.options=Object.extend(Object.clone(this.options),d||{});this.registerShortcuts("show");if(typeof(a.ModalPopup.instanceCounter)=="undefined"){a.ModalPopup.instanceCounter=0}this.id=++a.ModalPopup.instanceCounter},getBoxId:function(){return this.options.idPrefix+this.id},createDialog:function(e){this.dialog=new Element("div",{"class":"msdialog-modal-container"});if(this.options.extraDialogClassName){this.dialog.addClassName(this.options.extraDialogClassName)}this.screen=new Element("div",{"class":"msdialog-screen"}).setStyle({opacity:this.options.screenOpacity,backgroundColor:this.options.screenColor});this.dialog.update(this.screen);this.dialogBox=new Element("div",{"class":"msdialog-box",id:this.getBoxId()});if(this.options.extraClassName){this.dialogBox.addClassName(this.options.extraClassName)}this.dialogBox._x_contentPlug=new Element("div",{"class":"content"});this.dialogBox.update(this.dialogBox._x_contentPlug);this.dialogBox._x_contentPlug.update(this.content);if(this.options.title){var f=new Element("div",{"class":"msdialog-title"}).update(this.options.title);f.setStyle({color:this.options.titleColor,backgroundColor:this.options.borderColor});this.dialogBox.insertBefore(f,this.dialogBox.firstChild)}if(this.options.displayCloseButton){var c=new Element("div",{"class":"msdialog-close",title:"Close"}).update("&#215;");c.setStyle({color:this.options.titleColor});c.observe("click",this.closeDialog.bindAsEventListener(this));this.dialogBox.insertBefore(c,this.dialogBox.firstChild)}this.dialog.appendChild(this.dialogBox);this.dialogBox.setStyle({textAlign:"left",borderColor:this.options.borderColor,backgroundColor:this.options.backgroundColor});this.positionDialog();document.body.appendChild(this.dialog);if(typeof(Draggable)!="undefined"){new Draggable(this.getBoxId(),{handle:$(this.getBoxId()).down(".msdialog-title"),scroll:window,change:this.updateScreenSize.bind(this)})}this.dialog.hide();var d=function(g){if(this.dialog.visible()){this.updateScreenSize()}}.bindAsEventListener(this);["resize","scroll"].each(function(g){Event.observe(window,g,d)}.bind(this));Event.observe(document,"ms:popup:content-updated",d)},positionDialog:function(){switch(this.options.verticalPosition){case"top":this.dialogBox.setStyle({top:(document.viewport.getScrollOffsets().top+6)+"px"});break;case"bottom":this.dialogBox.setStyle({bottom:".5em"});break;default:var e=35;var d=e+"%";try{if(this.dialogBox.parentElement.clientHeight>window.innerHeight){d=Math.floor(window.pageYOffset+window.innerHeight*e/100)+"px"}}catch(c){}this.dialogBox.setStyle({top:d});break}this.dialogBox.setStyle({left:"",right:""});switch(this.options.horizontalPosition){case"left":this.dialog.setStyle({textAlign:"left"});break;case"right":this.dialog.setStyle({textAlign:"right"});break;default:this.dialog.setStyle({textAlign:"center"});this.dialogBox.setStyle({margin:"auto"});break}},positionDialogInViewport:function(d,c){this.dialogBox.setStyle({left:(document.viewport.getScrollOffsets().left+d)+"px",top:(document.viewport.getScrollOffsets().top+c)+"px",margin:"0"})},getPositionInViewport:function(){return this.dialogBox.viewportOffset()},updateScreenSize:function(){var c=function(h,k,e){var l=$(document.documentElement)[k]();var g=document.viewport.getScrollOffsets()[e]+document.viewport[k]();if(h){var f=h.cumulativeOffset()[e]+h[k]()}var d="";if(l<g){d=g+"px"}return d};this.screen.style.width=c(this.dialogBox,"getWidth","left");this.screen.style.height=c(this.dialogBox,"getHeight","top")},setClass:function(c){this.dialogBox.addClassName("msdialog-box-"+c)},removeClass:function(c){this.dialogBox.removeClassName("msdialog-box-"+c)},setContent:function(c){this.content=c;this.dialogBox._x_contentPlug.update(this.content);this.updateScreenSize()},showDialog:function(c){if(c){Event.stop(c)}if(!this.active){this.active=true;if(!this.dialog){this.createDialog()}this.attachKeyListeners();this.dialog.show();if(this.options.resetPositionOnShow){this.positionDialog()}this.updateScreenSize()}},onScroll:function(c){this.dialog.setStyle({top:document.viewport.getScrollOffsets().top+"px"})},closeDialog:function(c){if(c){Event.stop(c)}this.options.onClose.call(this);this.dialog.hide();if(this.options.removeOnClose){this.dialog.remove()}this.detachKeyListeners();this.active=false},attachKeyListeners:function(){for(var c in this.shortcuts){if(c!="show"){this.registerShortcuts(c)}}},detachKeyListeners:function(){for(var c in this.shortcuts){if(c!="show"){this.unregisterShortcuts(c)}}},registerShortcuts:function(e){var c=this.shortcuts[e].keys;var f=this.shortcuts[e].method;for(var d=0;d<c.size();++d){if(Prototype.Browser.IE||Prototype.Browser.WebKit){shortcut.add(c[d],f.bindAsEventListener(this,e),{type:"keyup"})}else{shortcut.add(c[d],f.bindAsEventListener(this,e),{type:"keypress"})}}},unregisterShortcuts:function(d){for(var c=0;c<this.shortcuts[d].keys.size();++c){shortcut.remove(this.shortcuts[d].keys[c])}},createButton:function(d,f,e,h){var g=new Element("span",{"class":"buttonwrapper"});var c=new Element("input",{type:d,"class":"button",value:f,title:e,id:h});g.update(c);return g},show:function(c){this.showDialog(c)},close:function(c){this.closeDialog(c)}});a.ModalPopup.active=false;return b}(PhenoTips||{}));var PhenoTips=(function(b){var a=b.widgets=b.widgets||{};a.SolrQueryProcessor=Class.create({initialize:function(d,c){this.queryFields=d;this.restriction=c},processQuery:function(c){return this.inflateQuery(c)},generateParameters:function(d){var c={defType:"edismax","spellcheck.collate":true,spellcheck:true,lowercaseOperators:false};if(this.setupMandatoryQuery(d,c)){return c}this.restrictQuery(d,c);this.setupQueryFields(d,c);return c},setupMandatoryQuery:function(h,g){var d=h.strip();var c="";var l=false;for(var k in this.queryFields){var f=this.queryFields[k];var e=f.activationRegex;if(!f.mandatory||!e||!d.match(e)){continue}c+=k+":"+(f.transform?f.transform(h):h)+" ";l=true}if(c){g.fq=c.strip()}return l},restrictQuery:function(h,g){if(!this.restriction){return}var c="";for(var d in this.restriction){var f=(d.substring(0,1)=="-"?"-":"+")+"(";for(var e=0;e<this.restriction[d].length;++e){f+=d.replace(/^-/,"")+":"+this.restriction[d][e].replace(/:/g,"\\:")+" "}f=f.strip()+") ";c+=f}if(c){g.fq=c.strip()}},setupQueryFields:function(h,n){var e=h.strip();var d="";var f="";var k="";var m=h.replace(/.*\W/g,"");for(var l in this.queryFields){var g=this.queryFields[l];var c=g.activationRegex;if(c&&!e.match(c)){continue}if(g.wordBoost){d+=l+"^"+g.wordBoost+" "}if(g.phraseBoost){f+=l+"^"+g.phraseBoost+(g.phraseSlop?"~"+g.phraseSlop:"")+" "}if(m&&g.stubBoost){k+=l+":"+m.replace(/:/g,"\\:")+"*^"+g.stubBoost+" "}}if(d){n.qf=d.strip()}if(f){n.pf=f.strip()}if(k){n.bq=k.strip()}},inflateQuery:function(d){var f=d.replace(/.*\W/g,"");if(!f){return d}var c=d;for(var e in this.queryFields){if(this.queryFields[e].stubTrigger){c+=" "+e+":"+f.replace(/:/g,"\\:")+"*"}}return c.strip()}});return b}(PhenoTips||{}));var PhenoTips=(function(b){var a=b.widgets=b.widgets||{};a.OntologyBrowser=Class.create({options:{script:XWiki.contextPath+"/rest/vocabularies/hpo/suggest?sort=nameSort asc&maxResults=10000&",json:true,varname:"input",method:"get",responseFormat:"application/json",resultsParameter:"rows",resultId:"id",resultValue:"name",resultCategory:"term_category",resultParent:{selector:"parents",processingFunction:function(c){return{id:c.id,value:c.name_translated||c.name}}},noresults:"No sub-terms",showParents:true,showRoot:true,enableSelection:true,enableBrowse:true,isTermSelected:function(c){return false},unselectTerm:function(c){},defaultEntryAction:"browse"},initialize:function(e,c,d){this.options=Object.extend(Object.clone(this.options),d||{});this.suggest=e;this.loadingMessage=new Element("div",{"class":"plainmessage loading"}).update("Loading\u2026");if(c){this.container=c}else{this.container=new b.widgets.ModalPopup(this.loadingMessage,{},{idPrefix:"ontology-browser-window-",title:"Related terms",backgroundColor:"#ffffff",verticalPosition:"top",extraDialogClassName:"dialog-ontology-browser",removeOnClose:true});this.options.modal=true}this._obrowserExpandEventHandler=this._obrowserExpandEventHandler.bindAsEventListener(this)},load:function(f){this.setContent(this.loadingMessage);var d=this.options.script+this.options.varname+"="+encodeURIComponent(f);var e={};e.Accept=this.options.responseFormat;var c=new Ajax.Request(d,{method:this.options.method,requestHeaders:e,onSuccess:function(g){this.setContent(this.buildTree(this._getDataFromResponse(g)));this.__crtRoot=f;if(this.container.content){Event.fire(document,"xwiki:dom:updated",{elements:[this.container.contentContainer||this.container.content]})}}.bind(this),onFailure:function(g){this.setContent("Failed to retrieve data: "+g.statusText);this.__crtRoot=""}.bind(this)})},expandTo:function(c,d){if(d.indexOf(this.__crtRoot)==-1){return}this._expandToStep(c,d.without(this.__crtRoot,c))},_expandToStep:function(c,e){var g=this;var f=this.container.contentContainer.down('li.entry input.select-tool[value="'+c.replace(/"/g,'\\"')+'"]');if(f){return}var d=false;e.each(function(k){if(d){return}var h=g.container.contentContainer.down('li.entry input.select-tool[value="'+k.replace(/"/g,'\\"')+'"]');if(h){var l=h.up("li");if(l.hasClassName("collapsed")||!l.down(".descendents")){Event.observe(l,"obrowser:expand:finished",function(m){Event.stopObserving(l,"obrowser:expand:finished");g._expandToStep(c,e.without(k))});g._toggleExpandState(l);d=true}}})},expand:function(f,d){var h=f.__termId;var g={};if(h.match(/^HP:[0-9]+$/i)){g.customFilter="is_a:"+h.toUpperCase().replace(/:/g,"\\:")}var e=this.options.script+this.options.varname+"="+encodeURIComponent(h);var k={};k.Accept=this.options.responseFormat;var c=new Ajax.Request(e,{method:this.options.method,requestHeaders:k,parameters:g,onCreate:function(){this._lockExpandTool(f)}.bind(this),onSuccess:function(n){var m={};if(d){var l=this.buildDescendentsList(this._getDataFromResponse(n));f.insert({bottom:l});Event.fire(document,"obrowser:content:added",{added:l,obrowser:this});Event.fire(f,"obrowser:expand:finished");Event.fire(this.container.contentContainer||document,"obrowser:expand:finished");Event.fire(document,"xwiki:dom:updated",{elements:[l]})}else{m.count=this.countDescendents(this._getDataFromResponse(n))}if((m.count===0)||(d&&!f.down(".descendents .entry, .error"))){f.addClassName("collapsed");var o=f.down(".expand-tool");if(o){o.update(this._getExpandCollapseSymbol(true)).addClassName("disabled");o.stopObserving("click")}}Event.fire(document,"ms:popup:content-updated",{popup:this.container})}.bind(this),onFailure:function(l){Event.fire(f,"obrowser:expand:failed",{data:new Element("div",{"class":"error"}).update("Failed to retrieve data: "+l.statusText),count:-1})},onComplete:function(){this._unlockExpandTool(f)}.bind(this)})},_getDataFromResponse:function(c){if(this.options.json){return c.responseJSON}return c.responseXML},_getResultset_json:function(c,d){return c&&c[d]||[]},_getResultFieldValue_json:function(c,d){return c&&(c[d+"_translated"]||c[d])||""},_getResultFieldValueAsArray_json:function(c,d){return new Array(c&&(c[d+"_translated"]||c[d])||"").flatten()},_getResultset_xml:function(e,c){var d=e&&e.getElementsByTagName(c);return d},_getResultFieldValue_xml:function(e,c){var d=e&&Element.down(e,c);return d&&d.firstChild&&d.firstChild.nodeValue||""},_getResultFieldValueAsArray_xml:function(e,d){var c=new Array();if(e){Element.select(e,d).each(function(f){var g=f.firstChild&&f.firstChild.nodeValue;if(g){c.push(g)}})}return c},_getResultset:function(c,d){if(this.options.json){return this._getResultset_json(c,d)}return this._getResultset_xml(c,d)},_getResultFieldValue:function(c,d){if(this.options.json){return this._getResultFieldValue_json(c,d)}return this._getResultFieldValue_xml(c,d)},_getResultFieldValueAsArray:function(c,d){if(this.options.json){return this._getResultFieldValueAsArray_json(c,d)}return this._getResultFieldValueAsArray_xml(c,d)},buildTree:function(h){var g=this._getResultset(h,this.options.resultsParameter);if(g.length==0){return new Element("div",{"class":"error"}).update(this.options.noresults)}var c=g[0];var e=new Element("div");if(this.options.showParents){var f=new Element("ul",{"class":"parents"});this._getResultFieldValueAsArray(c,this.options.resultParent.selector).each(function(k){var m=k;var l={};if(typeof(this.options.resultParent.processingFunction)=="function"){l=this.options.resultParent.processingFunction(m)}f.insert({bottom:this._createParentBranch(l)})}.bind(this));if(f.hasChildNodes()){e.insert({top:f})}Event.fire(document,"obrowser:content:added",{added:f,obrowser:this})}var h={id:this._getResultFieldValue(c,this.options.resultId),value:this._getResultFieldValue(c,this.options.resultValue),category:this._generateEntryCategory(c)};var d=this._createRoot(h);e.insert({bottom:d});Event.fire(document,"obrowser:content:added",{added:d,obrowser:this});return e},countDescendents:function(c){return this._getResultset(c,this.options.resultsParameter).length},buildDescendentsList:function(c){var e=this._getResultset(c,this.options.resultsParameter);var g=new Element("ul",{"class":"descendents"});for(var d=0;d<e.length;d++){var f={id:this._getResultFieldValue(e[d],this.options.resultId),value:this._getResultFieldValue(e[d],this.options.resultValue),category:this._generateEntryCategory(e[d])};g.insert({bottom:this._createDescendentBranch(f)})}if(g.hasChildNodes()){return g}return new Element("div",{"class":"descendents hint empty"}).update(this.options.noresults)},_createBranch:function(e,l,f,d){var g=new Element(e,{"class":"entry "+l});g.__termId=f.id;g.__termCategory=f.category;var c=new Element("div",{"class":"entry-data"});c.insert({bottom:this._generateEntryTitle(f.id,f.value)});var k=new Element("span",{"class":"entry-tools"});k.observe("click",function(n){n.stop()});c.insert({bottom:k});g.update(c);if(!this._isRootEntry(g)){if(this.options.defaultEntryAction=="browse"){c.down(".info").observe("click",this._browseEntry.bindAsEventListener(this))}}k.insert(new Element("span",{"class":"fa fa-info-circle phenotype-info xHelpButton",title:f.id,"data-source":this.suggest&&this.suggest.fld&&this.suggest.fld.id}));if(this.options.enableSelection){g.__selectTool=new Element("input",{type:"checkbox",name:"term_selector",value:f.id,"class":"select-tool"});c.insert({top:g.__selectTool});if(this.options.isTermSelected(g.__termId)){g.addClassName("accepted");g.__selectTool.checked="checked"}g.__selectTool.observe("click",this._toggleEntrySelection.bindAsEventListener(this));if(this.options.defaultEntryAction=="select"){c.down(".info").observe("click",this._toggleEntrySelection.bindAsEventListener(this))}}if(d){var m=new Element("span",{"class":"expand-tool"}).update(this._getExpandCollapseSymbol(!g.hasClassName("root")));m.observe("click",function(o){var n=o.element().up(".entry");if(!this._isExpandToolLocked(n)){this._toggleExpandState(n)}}.bindAsEventListener(this));var h=function(n){if(!this._isExpandToolLocked(g)&&n.memo.selected=="yes"){this._expandEntry(g)}};g.observe("obrowser:entry:selected",h.bindAsEventListener(this));g.observe("ynpicker:selectionChanged",h.bindAsEventListener(this));c.insert({top:m});this.expand(g,g.hasClassName("root"))}return g},_generateEntryTitle:function(d,c){return new Element("span",{"class":"info"}).insert({bottom:new Element("span",{"class":"key"}).update("["+d+"]")}).insert({bottom:" "}).insert({bottom:new Element("span",{"class":"value"}).update(c)})},_generateEntryCategory:function(d){var c=new Element("span",{"class":"hidden term-category"});if(this.options.resultCategory){this._getResultFieldValueAsArray(d,this.options.resultCategory).each(function(e){c.insert(new Element("input",{type:"hidden",value:e}))})}if(c.hasChildNodes()){return c}else{return null}},_expandEntry:function(c){if(!c){return}if(!c.down(".descendents")){c.down(".error")&&c.down(".error").remove();this.expand(c,true)}else{Event.fire(c,"obrowser:expand:finished")}c.removeClassName("collapsed");c.down(".expand-tool")&&c.down(".expand-tool").update(this._getExpandCollapseSymbol(false))},_collapseEntry:function(c){if(!c){return}c.addClassName("collapsed");Event.fire(c,"obrowser:expand:finished");c.down(".expand-tool")&&c.down(".expand-tool").update(this._getExpandCollapseSymbol(true))},_toggleExpandState:function(c){if(c){if(!c.down(".descendents")||c.hasClassName("collapsed")){this._expandEntry(c)}else{this._collapseEntry(c)}}},_obrowserExpandEventHandler:function(d){var c=d.element();if(!d.memo){return}if(d.memo.data){c.insert({bottom:d.memo.data});c.stopObserving("obrowser:expand:done",this._obrowserExpandEventHandler)}else{if(typeof(d.memo.count)!="undefined"){c.stopObserving("obrowser:count:done",this._obrowserExpandEventHandler)}}c.stopObserving("obrowser:expand:failed",this._obrowserExpandEventHandler);if((d.memo.count=="0")||(!c.hasClassName("root")&&d.memo.data&&!c.down(".descendents .entry, .error"))){c.addClassName("collapsed");var e=c.down(".expand-tool");if(e){e.update(this._getExpandCollapseSymbol(true)).addClassName("disabled");e.stopObserving("click")}}this._unlockExpandTool(c);Event.fire(document,"ms:popup:content-updated",{popup:this.container});if(d.memo.data){Event.fire(c,"obrowser:expand:finished")}},_lockExpandTool:function(c){var d=c.down(".expand-tool");if(d){d.addClassName("locked")}},_unlockExpandTool:function(c){var d=c.down(".expand-tool");if(d){d.removeClassName("locked")}},_isExpandToolLocked:function(c){if(c.down(".expand-tool.locked")){return true}return false},_getExpandCollapseSymbol:function(c){if(c){return"&#x25ba;"}return"&#x25bc;"},_toggleEntrySelection:function(e){var d=e.element();if(!d.hasClassName("select-tool")){d.up(".entry").down("input").click();return}var c=d.up(".entry");if(d.checked){this._selectEntry(c)}else{this._unselectEntry(c)}},_selectEntry:function(c){if(this.suggest){if(this.options.modal&&typeof(this.container.getPositionInViewport)=="function"){var e=this.container.getPositionInViewport()}var d=c.down(".value").firstChild.nodeValue;this.suggest.acceptEntry({id:c.__termId,value:d,category:c.__termCategory,negative:c.down(".selected.no")},d,"",true);c.addClassName("accepted");if(e&&(typeof(this.container.positionDialogInViewport)=="function")){this.container.positionDialogInViewport(e.left,e.top)}c.fire("obrowser:entry:selected",{selected:(c.down(".selected.no"))?"no":"yes"})}},_unselectEntry:function(c){this.options.unselectTerm(c.__termId);this.options.unselectTerm(c.__termId,true);c.removeClassName("accepted")},_browseEntry:function(d){d.stop();var c=d.element().up(".entry");this.load(c.__termId)},_createParentBranch:function(c){var c=this._createBranch("li","parent",c,false);return c},_createRoot:function(d){var c=this._createBranch("div","root",d,true);if(!this.options.showRoot){c.addClassName("no-root");c.down(".entry-data").addClassName("invisible")}return c},_createDescendentBranch:function(c){return this._createBranch("li","descendent",c,true)},_isRootEntry:function(c){return c.hasClassName("entry")&&c.hasClassName("root")},setContent:function(c){this.container.setContent(new Element("div",{"class":"ontology-tree"}).update(c))},show:function(c){if(c){this.container.show();if(this.__crtRoot!=c){this.load(c)}else{Event.fire(this.container.contentContainer||document,"obrowser:expand:finished")}}},hide:function(){this.container.close()}});return b}(PhenoTips||{}));var PhenoTips=(function(b){var a=b.widgets=b.widgets||{};a.DropDown=Class.create({options:{},initialize:function(d){this.element=d;this.hasForceOpen=false;var c=d.next(".dropdown");if(c){this.contentContainer=null;this.dropdown=c;this.hasForceOpen=true}else{this.dropdown=new Element("div",{"class":"dropdown"});this.contentContainer=new Element("div");this.dropdown.update(this.contentContainer)}},setContent:function(c){this.contentContainer!=null?this.contentContainer.update(c):null},show:function(c){if(c&&!this.hasForceOpen){return false}if(this.dropdown.hasClassName("invisible")){this.dropdown.removeClassName("invisible")}else{this.element.insert({after:this.dropdown})}return true},close:function(c){if(c&&!this.hasForceOpen){return false}this.dropdown.addClassName("invisible");return true}});return b}(PhenoTips||{}));StickyBox=Class.create({options:{offsetTop:6,offsetBottom:0,resize:false,isSticky:function(a){return true}},initialize:function(b,a,c){this.stickyElement=b;this.stickyAreaElement=a;if(this.stickyElement&&this.stickyAreaElement){this.options=Object.extend(Object.clone(this.options),c||{});if(this.options.shadowSize&&c.offsetTop===undefined){this.options.offsetTop=this.options.shadowSize}this.resetPosition=this.resetPosition.bindAsEventListener(this);Event.observe(window,"scroll",this.resetPosition);Event.observe(window,"resize",this.resetPosition);if(typeof(this.options.makeDefault)=="function"){this.makeDefault=this.options.makeDefault.bind(this)}this.resetPosition()}},resetPosition:function(){if(!this.options.isSticky(this.stickyElement)||this.stickyElement.getHeight()>=this.stickyAreaElement.getHeight()){return}this.stickyElement.style.height="";this.stickyElement.style.overflow="";this.stickyElement.fire("size:changed");this.boxHeight=this.stickyElement.getHeight();var c=document.viewport.getHeight()-this.options.offsetTop-this.options.offsetBottom;if(this.options.resize){var b={diff:(c-this.boxHeight),original:this.boxHeight};this.boxHeight=c;this.stickyElement.style.height=this.boxHeight+"px";this.stickyElement.style.overflow="auto";this.stickyElement.fire("size:changed",b)}this.boxWidth=this.stickyElement.getWidth();this.boxMinTop=this.stickyAreaElement.cumulativeOffset().top+this.options.offsetTop;this.boxMaxTop=this.stickyAreaElement.cumulativeOffset().top+this.stickyAreaElement.getHeight()-this.boxHeight;this.boxLeft=this.stickyElement.cumulativeOffset().left;this.boxRelativeLeft=this.boxLeft-this.stickyElement.getOffsetParent().viewportOffset().left;var a=this.stickyAreaElement.viewportOffset().top;this.direction=0;if(this.stickyAreaElement._prevPosition){if(this.stickyAreaElement._prevPosition>a){this.direction=1}else{if(this.stickyAreaElement._prevPosition<a){this.direction=-1}}}if((this.options.isSticky(this.stickyElement)||this.direction==1)&&document.viewport.getScrollOffsets().top>=this.boxMinTop&&document.viewport.getScrollOffsets().top<this.boxMaxTop){this.makeFixed()}else{if((this.options.isSticky(this.stickyElement)||this.direction==-1)&&document.viewport.getScrollOffsets().top>=this.boxMaxTop){this.makeAbsolute()}else{this.makeDefault()}}this.stickyAreaElement._prevPosition=a},makeFixed:function(){if(this.stickyElement.style.position!="fixed"){this.stickyElement.addClassName("sticky");this.stickyElement.style.left=this.boxLeft+"px";this.stickyElement.style.width=(this.boxWidth)+"px";this.stickyElement.style.top=this.options.offsetTop+"px";this.stickyElement.style.right="";this.stickyElement.style.position="fixed"}},makeAbsolute:function(b){if(this.stickyElement.style.position!="absolute"){this.stickyElement.addClassName("sticky");b=b||(this.stickyAreaElement.getHeight()-this.stickyElement.getHeight());this.stickyElement.style.top=b+"px";this.stickyElement.style.right="";var a=this.stickyElement.getStyle("position");this.stickyElement.style.position="absolute";if(a=="fixed"&&!Prototype.Browser.WebKit){this.stickyElement.style.left=(this.boxRelativeLeft-this.stickyElement.getOffsetParent().viewportOffset().left+2)+"px"}else{this.stickyElement.style.left=this.boxRelativeLeft+"px"}}},makeDefault:function(){if(this.stickyElement.style.position!=""){this.stickyElement.removeClassName("sticky");this.stickyElement.style.position="";this.stickyElement.style.top="";this.stickyElement.style.left="";this.stickyElement.style.right="";this.stickyElement.style.width=""}},isFixed:function(){return(this.stickyElement.style.position=="fixed")},isAbsolute:function(){return(this.stickyElement.style.position=="absolute")},isDefault:function(){return(this.stickyElement.style.position=="")}});var PhenoTips=(function(b){var a=b.widgets=b.widgets||{};a.FreeMultiselect=Class.create({counter:1,options:{returnKeyNavigation:false,extraClasses:""},initialize:function(f,e){this.options=Object.extend(Object.clone(this.options),e||{});var k=this;var h=f.previous('input[name="xwiki-free-multiselect-suggest-extraclasses"][type="hidden"]');if(h){this.options.extraClasses=h.value}var c=f.previous('input[name="xwiki-free-multiselect-suggest-script"][type="hidden"]');if(c&&c.value&&typeof(b.widgets.Suggest)!="undefined"){this.suggestOptions={script:c.value,shownoresults:false,varname:"input",timeout:0,resultsParameter:"rows",resultValue:"name",resultInfo:{}}}this.enhanceLine=this.enhanceLine.bind(this);var d=f.select("li input.xwiki-free-multiselect-value");d.each(this.enhanceLine);if(f.down("input.xwiki-free-multiselect-value")){var g=new Element("a",{title:"add",href:"#"+f.id}).update("+â€¦");f.insert(g.wrap("li"));g.observe("click",function(m){m.stop();var n=g.up("li").previous();var l=n&&n.down("input.xwiki-free-multiselect-value");if(l){k.generateInput(l)}}.bindAsEventListener(this))}},enhanceLine:function(c){c.id=this.generateId(c);c.up("li").addClassName("xwiki-free-multiselect-line");this.attachDeleteTool(c);if(this.suggestOptions){new b.widgets.Suggest(c,this.suggestOptions)}this.enableAddInput(c)},attachDeleteTool:function(d){var e=d.up(".xwiki-free-multiselect-line");var c=new Element("a",{title:"delete",href:"#"+d.id}).update("âœ–");e.insert(" ").insert(c);c.observe("click",function(f){f.stop();var h=f.findElement(".xwiki-free-multiselect-line");if(h.previous(".xwiki-free-multiselect-line")||h.next(".xwiki-free-multiselect-line")){h.remove()}else{var g=h.down("input");g.value="";g.focus()}})},enableAddInput:function(c){var e=c.up(".xwiki-free-multiselect-line");var d=this;if(!e){return}c.observe("keypress",function(h){if(h.keyCode==Event.KEY_RETURN){h.stop();var f=e.next(".xwiki-free-multiselect-line");if(d.options.returnKeyNavigation&&f&&f.down("input")){f.down("input").focus()}else{c.next().removeClassName("inactive");d.generateInput(c)}}else{if(h.keyCode==Event.KEY_BACKSPACE&&c.value==""){h.stop();var g=e.previous(".xwiki-free-multiselect-line");if(g&&g.down("input")){g.down("input").focus();c.up(".xwiki-free-multiselect-line").remove()}}}})},generateInput:function(d){var c=new Element("input",{name:d.name,id:this.generateId(d),type:d.type,size:d.size,"class":"xwiki-free-multiselect-value "+this.options.extraClasses});var e=new Element("li");e.insert(c);d.up(".xwiki-free-multiselect-line").insert({after:e});this.enhanceLine(c);c.focus()},generateId:function(c){return c.name+"_"+this.nextIndex()},nextIndex:function(){return ++this.counter},lastIndex:function(){return this.counter}});return b}(PhenoTips||{}));var init=function(a){((a&&a.memo.elements)||[$("body")]).each(function(b){b.select(".xwiki-free-multiselect").each(function(c){new PhenoTips.widgets.FreeMultiselect(c)})})};(XWiki.domIsLoaded&&init())||document.observe("xwiki:dom:loaded",init);document.observe("xwiki:dom:updated",init);var XWiki=(function(c){var a=c.widgets=c.widgets||{};a.VisibilityController=Class.create({initialize:function(e){this.element=e;this.reverse=this.element.hasClassName("exclude");this.controller=this.element.select(".controller input[type=checkbox]");var d="change";if(this.controller.length==0){return}else{if(this.controller.length==1){this.controller=this.controller[0]}else{this.controller=this.element.down(".controller .yes input[type=checkbox]");d="picker:change"}}if(!this.controller){return}this.controlled=this.element.select(".controlled");if(this.element.hasClassName("complete-hide")){this.hiddenStyle={display:"none"};this.visibleStyle={display:""}}else{this.hiddenStyle={visibility:"hidden"};this.visibleStyle={visibility:"visible"}}this.controlVisibility();if(this.element.hasClassName("confirm")){this.controller.observe(d,this.confirm.bindAsEventListener(this))}else{this.controller.observe(d,this.controlVisibility.bindAsEventListener(this))}},controlVisibility:function(){if(this.controller.checked^this.reverse){this.controlled.invoke("setStyle",this.hiddenStyle);this.element.select(".controlled input").invoke("disable")}else{this.controlled.invoke("setStyle",this.visibleStyle);this.element.select(".controlled input").invoke("enable")}},confirm:function(d){if(this.element.hasClassName("confirm-yes")&&!this.controller.checked||this.element.hasClassName("confirm-no")&&this.controller.checked){this.controlVisibility();return}new c.widgets.ConfirmationBox({onYes:function(){this.controlVisibility()}.bind(this),onNo:function(){this.controller.checked=!this.controller.checked}.bind(this),},{confirmationText:"This will remove all table data entered below. Are you sure you want to proceed?",showCancelButton:false})}});var b=function(d){((d&&d.memo.elements)||[$("body")]).each(function(e){e.select(".controlled-group").each(function(f){if(!f.__visibilityController){f.__visibilityController=new c.widgets.VisibilityController(f)}})});return true};(c.domIsLoaded&&b())||document.observe("xwiki:dom:loaded",b);document.observe("xwiki:dom:updated",b);return c}(XWiki||{}));var PhenoTips=(function(b){var a=b.widgets=b.widgets||{};a.UnitConverter=Class.create({CONVERSION_META:{weight:{imperial_units:["lb","oz"],metric_unit:"kg",inter_unit_scale:16,inter_system_scale:0.0283495},length:{imperial_units:["ft","in"],metric_unit:"cm",inter_unit_scale:12,inter_system_scale:2.54}},DEFAULT_UNIT_SYSTEM:"metric",initialize:function(e,c,f,d,g){this._selector=c;this._container=e||document.documentElement;if(!this._selector||!f){return}this.crtUnitSystem=g||this.DEFAULT_UNIT_SYSTEM;this.initializeElements=this.initializeElements.bind(this);this.attachConverter=this.attachConverter.bind(this);this.generateTrigger(f,d||"bottom");this.initializeElements();var h=this;document.observe("xwiki:dom:updated",function(k){if(k.memo&&k.memo.elements){k.memo.elements.each(h.initializeElements.bind(h))}})},generateTrigger:function(e,c){this._trigger=new Element("select",{"class":"unit-system-selector"});var d=new Element("option",{value:"metric",}).update("Metric units ("+this.CONVERSION_META.weight.metric_unit+", "+this.CONVERSION_META.length.metric_unit+")");if(this.crtUnitSystem=="metric"){d.selected="selected"}var f=new Element("option",{value:"imperial",}).update("Imperial units ("+this.CONVERSION_META.weight.imperial_units.join(" / ")+", "+this.CONVERSION_META.length.imperial_units.join(" / ")+")");if(this.crtUnitSystem=="imperial"){f.selected="selected"}this._trigger.insert(d).insert(f);insertionInfo={};insertionInfo[c]=this._trigger;e.insert(insertionInfo);var g=this;this._trigger.observe("change",function(h){g.crtUnitSystem=g._trigger.options[g._trigger.selectedIndex].value;g.switchUnits(g.crtUnitSystem)})},initializeElements:function(c){container=c||this._container;if(container.__unitSwitcher||(!container.up(".measurements")&&!container.hasClassName("measurements"))){return}container.__unitSwitcher=this;container.select(this._selector).each(this.attachConverter);this.switchUnits(this.crtUnitSystem,container)},switchUnits:function(d,c){container=c||this._container;container.select(".unit-conversion-values .unit-type").each(function(e){if(e.hasClassName(d)){e.show()}else{e.hide()}})},attachConverter:function(d){if(d.tagName.toLowerCase()!="input"||d.type!="text"){return}var k=d.next(".unit");var h=new Element("div",{"class":"unit-conversion-values"});var l;var e=(d.up(".weight"))?"weight":"length";h.addClassName(e);h._meta=this.CONVERSION_META[e];var c=this.metricToImperial(h._meta,parseFloat(d.value)||0);var g=d.up(".metric");if(!g){g=new Element("div",{"class":"unit-type metric"});g.insert(d).insert(k||h._meta.metric_unit);d.insert({after:h})}else{g.addClassName("unit-type");g.insert({after:h})}var f=new Element("div",{"class":"unit-type imperial"});h.insert(g).insert(f);h._meta.imperial_units.each(function(m){f.insert(new Element("label").insert(new Element("input",{style:"width: auto",name:m,type:"text",size:3,value:(c[m]||"")})).insert(m))});this.enableSyncValues(h)},enableSyncValues:function(c){var d=this;c.select(".imperial input").invoke("observe","change",function(e){d.syncMetricWithImperial(c)});c.select(".metric input").invoke("observe","change",function(e){d.syncImperialWithMetric(c)})},syncMetricWithImperial:function(d){var c=d.down(".metric input");c.value=this.imperialToMetric(d._meta,parseFloat(d.down('.imperial input[name="'+d._meta.imperial_units[0]+'"]').value)||0,parseFloat(d.down('.imperial input[name="'+d._meta.imperial_units[1]+'"]').value)||0)||"";Event.fire(c,"phenotips:measurement-updated")},syncImperialWithMetric:function(d){var c=this.metricToImperial(d._meta,parseFloat(d.down(".metric input").value)||0);d._meta.imperial_units.each(function(e){d.down('.imperial input[name="'+e+'"]').value=c[e]||""})},metricToImperial:function(e,g){var c={};var f=g/e.inter_system_scale;var d=Math.floor(f/e.inter_unit_scale);f=f-d*e.inter_unit_scale;if(f){f=f.toFixed(2)}c[e.imperial_units[0]]=d;c[e.imperial_units[1]]=f;return c},imperialToMetric:function(d,c,e){return((d.inter_unit_scale*c+e)*d.inter_system_scale).toFixed(2)}});return b}(PhenoTips||{}));var PhenoTips=(function(c){var a=c.widgets=c.widgets||{};a.HelpButton=Class.create({infoServices:{xHelpButton:{hint:"How to enter this information",callback:function(d){d.helpBox.content.update(d._information||"")}},"phenotype-info":{hint:"About this phenotype",vocabulary:"hpo",database:{name:"The Human Phenotype Ontology (HPO)",link:"http://human-phenotype-ontology.github.io/",citation:"The Human Phenotype Ontology project: linking molecular biology and disease through phenotype data. Sebastian KÃ¶hler, Sandra C Doelken, Christopher J. Mungall, Sebastian Bauer, Helen V. Firth, et al. Nucl. Acids Res. (1 January 2014) 42 (D1): D966-D974 doi:10.1093/nar/gkt1026",version:"releases/2017-12-12"},callback:function(f,n){var k=f.helpBox.content;var e=function(p,l,q){return new Element(p,l&&{"class":l}||{}).update(q||"")};k.update(e("span","info").insert(e("span","key").update(n.id)).insert(" ").insert(e("span","value").update(n.name_translated)));n.def_translated&&k.insert(e("p").update(n.def_translated.replace(/\s*\n\s*/," ").replace(/`([^`]+)`\s+\(([A-Z]+:[0-9]+)`?\)/g,'<em title="$2">$1</em>')));var h={synonym:"Also known as",parents:"Is a type of"};var o=e("dl");for(var d in h){if(n[d]){o.insert(e("dt","",h[d]));n[d].each(function(l){o.insert(e("dd","",l.name_translated||l))})}}if(o.firstDescendant()){k.insert(o)}var g=f.icon.getAttribute("data-source")&&$(f.icon.getAttribute("data-source"))||$("quick-phenotype-search")||$$("input.suggest-hpo")[0];if(c.widgets.OntologyBrowser&&g){var m=new Element("a",{"class":"button",href:"#"}).update("Browse related termsâ€¦");m._id=n.id;m.observe("click",function(l){l.stop();var q=g._suggest;var p={};if(typeof isPhenotypeSelected!=="undefined"){p={isTermSelected:isPhenotypeSelected,unselectTerm:unselectPhenotype}}m._obrowser=new c.widgets.OntologyBrowser(q,null,p);m._obrowser.show(m._id)});k.insert(e("div","term-tools").insert(m.wrap("span",{"class":"buttonwrapper"})))}}},"phenotype-qualifier-info":{hint:"About this phenotype qualifier",vocabulary:"hpo",database:{name:"The Human Phenotype Ontology (HPO)",link:"http://human-phenotype-ontology.github.io/",citation:"The Human Phenotype Ontology project: linking molecular biology and disease through phenotype data. Sebastian KÃ¶hler, Sandra C Doelken, Christopher J. Mungall, Sebastian Bauer, Helen V. Firth, et al. Nucl. Acids Res. (1 January 2014) 42 (D1): D966-D974 doi:10.1093/nar/gkt1026",version:"releases/2017-12-12"},callback:function(f,e){var g=f.helpBox.content;var d=function(k,h,l){return new Element(k,h&&{"class":h}||{}).update(l||"")};g.update(d("span","info").insert(d("span","key").update(e.id)).insert(" ").insert(d("span","value").update(e.name_translated)));e.def_translated&&g.insert(d("p").update(e.def_translated.replace(/\s*\n\s*/," ").replace(/`([^`]+)`\s+\(([A-Z]+:[0-9]+)`?\)/g,'<em title="$2">$1</em>')))}},"omim-disease-info":{hint:"About this disease",vocabulary:"omim",database:{name:"Online Mendelian Inheritance in Man (OMIM)",link:"http://www.omim.org/",citation:"Online Mendelian Inheritance in Man, OMIMÂ®. McKusick-Nathans Institute of Genetic Medicine, Johns Hopkins University (Baltimore, MD)",version:"2017-05-08T16:25:23.918Z"},callback:function(f,n){var k=f.helpBox.content;var e=function(p,l,q){return new Element(p,l&&{"class":l}||{}).update(q||"")};k.update(e("span","info").insert(e("span","key").update((n.symbol||"")+n.id)).insert(" ").insert(e("span","value").update(n.name_translated)));var g={short_name:"",synonym:"Also known as",included_name:"Includes"};var o=e("dl");for(var d in g){if(n[d]&&n[d].length>0){o.insert(e("dt","",g[d]));n[d].each(function(l){o.insert(e("dd","",l.label||l))})}}if(o.firstDescendant()){k.insert(o)}var m=new Element("a",{"class":"button",href:"http://www.omim.org/entry/"+n.id,target:"_blank"}).update("Read about it on OMIM.orgâ€¦");k.insert(e("div","term-tools").insert(m.wrap("span",{"class":"buttonwrapper"})));m.observe("click",function(l){l.stop();window.open(m.href)});if(n.gene_reviews_link){var h=new Element("a",{"class":"button",href:n.gene_reviews_link,target:"_blank"}).update("Read about it on Gene Reviewsâ€¦");k.insert(e("div","term-tools").insert(h.wrap("span",{"class":"buttonwrapper"})));h.observe("click",function(l){l.stop();window.open(h.href)})}}},"ordo-disease-info":{hint:"About this disease",vocabulary:"ordo",database:{name:"Orphanet Rare Disease Ontology",link:"http://www.orpha.net/",citation:"Orphadata: Free access data from Orphanet. Â© INSERM 1997",version:"2.3"},externalDBs:[{name:"Ensembl",url:"http://useast.ensembl.org/Homo_sapiens/Gene/Compara_Tree?g=",field:"ensembl_id"},{name:"GenAtlas",url:"http://genatlas.medecine.univ-paris5.fr/fiche.php?symbol=",field:"genatlas_id"},{name:"HGNC",url:"http://www.genenames.org/cgi-bin/gene_symbol_report?hgnc_id=",field:"hgnc_id"},{name:"ICD-10",url:"http://icdlist.com/icd-10/",field:"icd-10_id"},{name:"IUPHAR",url:"http://guidetopharmacology.org/GRAC/ObjectDisplayForward?objectId=",field:"iuphar_id"},{name:"MedDRA",url:"http://purl.bioontology.org/ontology/MEDDRA/",field:"meddra_id"},{name:"MeSH",url:"https://www.ncbi.nlm.nih.gov/mesh/",field:"mesh_id"},{name:"OMIM",url:"http://www.omim.org/entry/",field:"omim_id"},{name:"UniProt",url:"http://www.uniprot.org/uniprot/",field:"swissprot_id"},{name:"UMLS",url:"https://uts.nlm.nih.gov/metathesaurus.html?cui=",field:"umls_id"}],callback:function(k,g){var n=k.helpBox.content;var f=function(o,l,p){return new Element(o,l&&{"class":l}||{}).update(p||"")};n.update(f("span","info").insert(f("span","key").update(g.id)).insert(" ").insert(f("span","value").update(g.name_translated)));g.def_translated&&n.insert(f("p").update(g.def_translated.replace(/\s*\n\s*/," ")));var m={alternative_term:"Also known as",parents:"Is a type of"};var d=f("dl");for(var e in m){if(g[e]){d.insert(f("dt","",m[e]));g[e].each(function(l){d.insert(f("dd","",l.name_translated||l))})}}if(d.firstDescendant()){n.insert(d)}var h=f("div","term-tools");this.externalDBs.each(function(l){var o=g[l.field];if(o){if(!o.each){o=[o]}o.each(function(p){h.insert(new Element("a",{href:l.url+p,"class":"button"}).update(l.name+": "+p).wrap("span",{"class":"buttonwrapper"}))})}});h.select("a").each(function(l){l.observe("click",function(o){o.stop();window.open(l.href)})});if(h.firstDescendant()){n.insert(h)}}},"gene-info":{hint:"About this gene",vocabulary:"hgnc",database:{name:"HUGO Gene Nomenclature Committee's GeneNames (HGNC)",link:"http://www.genenames.org/",citation:"HGNC Database, HUGO Gene Nomenclature Committee (HGNC), EMBL Outstation - Hinxton, European Bioinformatics Institute, Wellcome Trust Genome Campus, Hinxton, Cambridgeshire, CB10 1SD, UK",version:"2017-07-17T02:26:39.671Z"},externalDBs:[{name:"GENECARDS",url:"http://www.genecards.org/cgi-bin/carddisp.pl?gene=",field:"genecards_id"},{name:"OMIM",url:"http://www.omim.org/entry/",field:"omim_id"},{name:"Entrez",url:"http://www.ncbi.nlm.nih.gov/gene/?term=",field:"entrez_id"},{name:"RefSeq",url:"http://www.ncbi.nlm.nih.gov/nuccore/",field:"refseq_accession"},{name:"Ensembl",url:"http://useast.ensembl.org/Homo_sapiens/Gene/Compara_Tree?g=",field:"ensembl_gene_id"},{name:"Gene panels",url:"https://www.ncbi.nlm.nih.gov/gtr/all/tests/?term=",field:"genecards_id"}],callback:function(k,g){var n=k.helpBox.content;var f=function(o,l,p){return new Element(o,l&&{"class":l}||{}).update(p||"")};n.update(f("span","info").insert(f("span","key").update(g.symbol)).insert(" ").insert(f("span","value").update(g.name_translated)));var m={alias_symbol:"Aliases",prev_symbol:"Previous symbols",gene_family:"Gene family"};var d=f("dl");for(var e in m){if(g[e]&&g[e].length>0){d.insert(f("dt","",m[e]));if(Object.prototype.toString.call(g[e])==="[object Array]"){g[e].each(function(l){d.insert(f("dd","",l.name_translated||l))})}else{d.insert(f("dd","",g[e]))}}}if(d.firstDescendant()){n.insert(d)}var h=f("div","term-tools");this.externalDBs.each(function(l){var o=g[l.field];if(o){if(!o.each){o=[o]}o.each(function(p){h.insert(new Element("a",{href:l.url+p,"class":"button"}).update(l.name+": "+p).wrap("span",{"class":"buttonwrapper"}))})}});h.select("a").each(function(l){l.observe("click",function(o){o.stop();window.open(l.href)})});if(h.firstDescendant()){n.insert(h)}}}},initialize:function(e){this.icon=e;this._information=this.icon._information||this.icon.title;for(var d in this.infoServices){if(this.icon.hasClassName(d)){this._builder=this.infoServices[d];this.icon.title=this.infoServices[d].hint||""}}if(!this._builder){return}this.icon.observe("click",this.toggleHelp.bindAsEventListener(this));this.hideAllHelpOnOutsideClick=this.hideAllHelpOnOutsideClick.bindAsEventListener(this)},toggleHelp:function(){if(!this.helpBox||this.helpBox.hasClassName("hidden")){this.showHelp();document.observe("click",this.hideAllHelpOnOutsideClick)}else{this.hideHelp()}},hideAllHelpOnOutsideClick:function(d){if(!d.findElement(".xTooltip")&&!d.findElement(".xHelpButton")){this.hideHelp();document.stopObserving("click",this.hideAllHelpOnOutsideClick)}},hideHelp:function(d){d&&d.stop();if(this.helpBox){if(this.helpBox.hasClassName("error")){this.helpBox.remove();delete this.helpBox}else{this.helpBox.addClassName("hidden")}}},showHelp:function(){if(!this.helpBox){this.createHelpBox()}$$("div.xTooltip:not(.hidden)").invoke("_hideHelp");this.helpBox.removeClassName("hidden")},createHelpBox:function(){this.helpBox=new Element("div",{"class":"hidden xTooltip"});this.helpBox._behavior=this;this.helpBox._hideHelp=function(){this._behavior.hideHelp()}.bind(this.helpBox);this.helpBox.content=new Element("div");this.helpBox.insert(this.helpBox.content);if(this._builder.service||this._builder.vocabulary){this.createHelpContentFromService()}else{this._builder.callback&&this._builder.callback(this)}var d=new Element("span",{"class":"hide-tool",title:"Hide"});d.update("Ã—");d.observe("click",this.hideHelp.bindAsEventListener(this));this.helpBox.insert({top:d});this.icon.insert({after:this.helpBox})},createHelpContentFromService:function(){var e=this;var d=XWiki.contextPath+"/rest/vocabularies/"+e._builder.vocabulary+"/"+e._information;new Ajax.Request(d,{parameters:{id:e._information},method:"get",onCreate:function(){e.helpBox.content.update(new Element("span",{"class":"hint temporary"}).update("Loadingâ€¦"))},onSuccess:function(f){e._builder.callback(e,f.responseJSON)},onFailure:function(f){e.helpBox.addClassName("error");e.helpBox.down(".temporary").remove();e.helpBox.insert("Failed to retrieve information about __subject__".replace("__subject__",e._information)+" : "+f.statusText)}});this.addDatabaseCreditInfo()},addDatabaseCreditInfo:function(){var e="Current version: "+this._builder.database.version+"";var g=this._builder.database.citation.concat(". ").concat(e);var f=new Element("a",{"class":"reference",href:this._builder.database.link,target:"_blank",title:g}).update(this._builder.database.name);var d=new Element("div",{"class":"hint"}).update(f.wrap("span",{"class":"reference-wrapper"}));this.helpBox.insert({top:d});f.observe("click",function(h){h.stopPropagation()})}});var b=function(d){((d&&d.memo.elements)||[$("body")]).each(function(e){(e.hasClassName("xHelpButton")?[e]:e.select(".xHelpButton")).each(function(f){if(!f.__helpController){f.__helpController=new c.widgets.HelpButton(f)}})});return true};(XWiki.domIsLoaded&&b())||document.observe("xwiki:dom:loaded",b);document.observe("xwiki:dom:updated",b);return c}(PhenoTips||{}));var PhenoTips=(function(c){var a=c.widgets=c.widgets||{};a.FuzzyDatePickerDropdown=Class.create({initialize:function(d){this.span=new Element("span");this.options=d;this.callback=null},populate:function(e){var d=this.dropdown?(this.dropdown.selectedIndex||this._tmpSelectedIndex):0;var f='<select name="'+this.options.name+'" class="'+(this.options.cssClass||this.options.name||"")+'" placeholder="'+(this.options.hint||this.options.name||"")+'" title="'+(this.options.hint||this.options.name||"")+'">';f+='<option value="" class="empty"> </option>';e.each(function(g){f+='<option value="'+g.value+'"';if(g.cssClass){f+=' class="'+g.cssClass+'"'}if(g.selected){f+=' selected="selected"'}f+=">"+(g.text||g.value||"")+"</option>"});f+="</select>";this.span.innerHTML=f;this.dropdown=this.span.firstChild;this.callback&&this.onSelect(this.callback);if(this.dropdown.selectedIndex<=0&&d>=0&&d<this.dropdown.options.length){this.dropdown.selectedIndex=d}},enable:function(){this.dropdown.enable();if(this.dropdown.selectedIndex<=0&&this._tmpSelectedIndex<this.dropdown.options.length){this.dropdown.selectedIndex=this._tmpSelectedIndex;return(this._tmpSelectedIndex>0)}return false},disable:function(){this.dropdown.disable();this._tmpSelectedIndex=this.dropdown.selectedIndex;this.dropdown.selectedIndex=0},getElement:function(){return this.span},onSelect:function(f){var e=this;this.callback=f;var d=["change"];browser.isGecko&&d.push("keyup");d.each(function(g){e.dropdown.observe(g,function(){f();e._tmpSelectedIndex=e.dropdown.selectedIndex})})},onFocus:function(e){var d=this;this.dropdown.observe("focus",function(){e();if(d.dropdown.selectedIndex==-1&&d._tmpSelectedIndex<d.dropdown.options.size()){d.dropdown.selectedIndex=d._tmpSelectedIndex}})},onBlur:function(d){this.dropdown.observe("blur",d)},getSelectedValue:function(){return(this.dropdown.selectedIndex>=0)?this.dropdown.options[this.dropdown.selectedIndex].value:""},getSelectedClass:function(){return(this.dropdown.selectedIndex>=0)?this.dropdown.options[this.dropdown.selectedIndex].className:""},getSelectedOption:function(){return(this.dropdown.selectedIndex>=0)?this.dropdown.options[this.dropdown.selectedIndex].innerHTML:""}});a.FuzzyDatePicker=Class.create({initialize:function(d){if(!d||d.hasClassName("initialized")){return}this.__input=d;this.__input.hide();this.__fuzzyInput=$(this.__input.name+"_entered");if(this.__fuzzyInput){this.__recordBoth=true}if(this.__fuzzyInput&&this.__fuzzyInput.value){this.__date=JSON.parse(this.__fuzzyInput.value||"{}")}else{if(this.__input.alt){var f=new Date(this.__input.alt);this.__date={year:f.getUTCFullYear(),month:f.getUTCMonth()+1,day:f.getUTCDate()}}else{this.__date={}}}this.container=new Element("div",{"class":"fuzzy-date-picker"});this.__input.insert({before:this.container});var g=(this.__input.title||"yyyy-MM-dd").split(/\W+/);for(var e=0;e<g.length;++e){switch(g[e][0]){case"y":this.container.insert(this.createYearDropdown());break;case"M":this.container.insert(this.createMonthDropdown());break;case"d":this.container.insert(this.createDayDropdown());break}}this.container.observe("datepicker:date:changed",this.onProgrammaticUpdate.bind(this));this.onProgrammaticUpdate();this.__input.addClassName("initialized");Event.fire(document,"xwiki:dom:updated",[this.container])},onProgrammaticUpdate:function(){this.yearSelected();this.monthSelected();this.updateDate()},createYearDropdown:function(){this.yearSelector=new a.FuzzyDatePickerDropdown({name:"year"});var g=new Date();var l=g.getYear()+1900;var f=1900;var e=(this.__date.hasOwnProperty("range")&&this.__date.range.hasOwnProperty("years"))?this.__date.range.years:1;var k=this.__date.hasOwnProperty("year")?this.__date.year:null;var d=[];if(k>l){d.push({value:k,selected:true})}for(var m=l;m>=f;--m){d.push({value:m,selected:((k==m)&&(e<=1))});if(m%10==0){d.push({value:(m+"s"),cssClass:"decade",text:(m+"s"),selected:((k==m)&&(e>1))})}}var h=function(o){var n=o+100;if(k!=null&&k>=o&&k<n&&e==1){d.push({value:k,selected:true})}var p=(k!=null)&&(k>=o)&&(k<n)&&(e>1);d.push({value:o+"s",cssClass:"century",selected:p})};h(1800);h(1700);h(1600);h(1500);if(k!=null&&k<1500){d.push({value:k,selected:true})}this.yearSelector.populate(d);this.yearSelector.onSelect(this.yearSelected.bind(this));return this.yearSelector.getElement()},yearSelected:function(){if(!this.yearSelector){return}if(this.yearSelector.getSelectedValue()>0){this.monthSelector&&this.monthSelected()}this.updateDate()},createMonthDropdown:function(){this.monthSelector=new a.FuzzyDatePickerDropdown({name:"month"});this.monthSelector.populate(this.getZeroPaddedValueRange(1,12,this.__date.month));this.monthSelector.onSelect(this.monthSelected.bind(this));return this.monthSelector.getElement()},monthSelected:function(){if(!this.monthSelector){return}if(this.monthSelector.getSelectedValue()>0){this.daySelector&&this.daySelector.populate(this.getAvailableDays())}this.updateDate()},createDayDropdown:function(){this.daySelector=new a.FuzzyDatePickerDropdown({name:"day"});this.daySelector.populate(this.getZeroPaddedValueRange(1,31,this.__date.day));this.daySelector.onSelect(this.updateDate.bind(this));return this.daySelector.getElement()},getAvailableDays:function(){var e=this.yearSelector.getSelectedValue()*1;var f=this.monthSelector.getSelectedValue()*1;var d=0;if([1,3,5,7,8,10,12].indexOf(f)>=0){d=31}else{if([4,6,9,11].indexOf(f)>=0){d=30}else{if(f==2){if(e%4==0&&(e%100!=0||e%400==0)){d=29}else{d=28}}}}return this.getZeroPaddedValueRange(1,d)},getZeroPaddedValue:function(d){return d?("0"+d).slice(-2):"01"},getZeroPaddedValueRange:function(h,d,g){var f=[];if(h<=d){for(var e=h;e<=d;++e){f.push({value:e,text:("0"+e).slice(-2),selected:g==e})}}else{for(var e=d;e<=h;--e){f.push({value:e,text:("0"+e).slice(-2),selected:g==e})}}return f},updateDate:function(){var k={};var o=this.yearSelector.getSelectedValue();var f=o.match(/(\d\d\d\d)s$/);if(f){var g=(this.yearSelector.getSelectedClass()=="century")?100:10;k.range={years:g};k.year=parseInt(f[1])}else{if(o!=""){k.year=parseInt(o)}}if(o>0){var e=this.monthSelector&&this.monthSelector.getSelectedValue();if(e>0){k.month=parseInt(this.monthSelector.getSelectedOption());var n=this.daySelector&&this.daySelector.getSelectedValue();if(n>0){k.day=parseInt(this.daySelector.getSelectedOption())}}}var l=JSON.stringify(k);if(this.__recordBoth){var h=this.__fuzzyInput.value;if(l!=h){this.__fuzzyInput.value=JSON.stringify(k);this.__input.value=(o&&!o.match(/\d\d\d\ds$/))?(o+"-"+this.getZeroPaddedValue(e)+"-"+this.getZeroPaddedValue(n)):"";this.__input.alt=(o&&!o.match(/\d\d\d\ds$/))?(o+"-"+this.getZeroPaddedValue(e)+"-"+this.getZeroPaddedValue(n)+"T00:00:00Z"):"";this.__input.fire("xwiki:date:changed")}}else{var h=this.__input.value;if(l!=h){this.__input.value=JSON.stringify(k);this.__input.alt=(o&&!o.match(/\d\d\d\ds$/))?(o+"-"+this.getZeroPaddedValue(e)+"-"+this.getZeroPaddedValue(n)+"T00:00:00Z"):"";this.__input.fire("xwiki:date:changed")}}}});var b=function(d){((d&&d.memo.elements)||[$("body")]).each(function(e){(e.hasClassName("fuzzy-date")?[e]:e.select(".fuzzy-date")).each(function(f){if(!f.__datePicker){f.__datePicker=new c.widgets.FuzzyDatePicker(f)}})});return true};(XWiki.domIsLoaded&&b())||document.observe("xwiki:dom:loaded",b);document.observe("xwiki:dom:updated",b);return c}(PhenoTips||{}));(function(){var a=function(b){var c=(b&&b.memo.elements)||[$("body")];c.each(function(d){d.select("input.suggestUsersAndGroups").each(function(e){if(!e.hasClassName("initialized")){var f={script:XWiki.contextPath+"/rest/principals/suggest",noresults:"No users or groups found"};new XWiki.widgets.UserPicker(e,f);e.addClassName("initialized")}})})};(XWiki.domIsLoaded&&a())||document.observe("xwiki:dom:loaded",a);document.observe("xwiki:dom:updated",a)})();var PhenoTips=(function(b){var a=b.widgets=b.widgets||{};a.SegmentedBar=Class.create({options:{segments:5,displayValue:true},initialize:function(d,c){this.value=d;this.options=Object.extend(Object.clone(this.options),c||{})},generateSegmentedBar:function(){if(this.value>1||this.value<0){console&&console.warn("Invalid segmented bar value");return}var g=new Element("div",{"class":"segmented-bar",title:Math.round(this.value*100)+"%"||""});var d=1/this.options.segments;for(var e=0;e<this.options.segments;++e){var c=100*Math.min(Math.max((this.value-e*d)/d,0),1);var f=new Element("span",{"class":"segmented-unit"});var h=new Element("span",{"class":"segmented-unit-fill"});h.setStyle({width:c+"%",});f.insert(h);g.insert(f)}if(this.options.displayValue){g.insert(" "+Math.round(this.value*100)+"%")}return g}});return b})(PhenoTips||{});var XWiki=(function(c){var a=c.widgets=c.widgets||{};a.SingleSubmitForm=Class.create({initialize:function(d){this.form=d;this.form.observe("submit",this.lockForm.bindAsEventListener(this));window.addEventListener("pageshow",this.unlockForm.bindAsEventListener(this))},lockForm:function(d){if(this.submitted){d.stop()}else{this.submitted=true}},unlockForm:function(d){this.submitted=false}});var b=function(d){((d&&d.memo.elements)||[$("body")]).each(function(e){e.select("form.x-single-submit-form").each(function(f){if(!f.__singleSubmit){f.__singleSubmit=new c.widgets.SingleSubmitForm(f)}})});return true};(c.domIsLoaded&&b())||document.observe("xwiki:dom:loaded",b);document.observe("xwiki:dom:updated",b);return c}(XWiki||{}));var XWiki=(function(c){var a=c.widgets=c.widgets||{};a.UniquenessValidator=Class.create({initialize:function(d){this.entityType=$("entity-type")&&$("entity-type").value;if(!this.entityType){return}this.input=d;this.valid=true;this.state="NEW";this.request=0;this.value=d.value;this.serviceUrl=new c.Document("CheckID","PhenoTips").getURL("get");if(!this.input.__validation){this.input.__validation=new LiveValidation(this.input,{validMessage:"",wait:500})}this.input.__validation.add(this.validate.bind(this))},check:function(){if(this.input.value!=this.value){this.value=this.input.value;this.state="CHECKING";new Ajax.Request(this.serviceUrl,{parameters:{outputSyntax:"plain",eid:this.value,id:c.Model.serialize(new c.DocumentReference(c.currentDocument.wiki,c.currentDocument.space,c.currentDocument.page)),entity:this.entityType},on200:this.self.bindAsEventListener(this),on403:this.empty.bindAsEventListener(this),on404:this.available.bindAsEventListener(this),on409:this.exists.bindAsEventListener(this),onComplete:this.responded.bindAsEventListener(this)})}},validate:function(d){if(this.state=="DONE"){this.value==d&&(this.valid||Validate.fail("This identifier already exists"))}this.check();return true},self:function(){this.valid=true},available:function(){this.valid=true},empty:function(){this.valid=false},exists:function(){this.valid=false},responded:function(){this.state="DONE";this.input.__validation.validate()}});var b=function(d){((d&&d.memo.elements)||[$("body")]).each(function(e){e.select("input.check-unique, .external_id input").each(function(f){if(!f.__uniqueness_validator){f.__uniqueness_validator=new c.widgets.UniquenessValidator(f)}})});return true};(c.domIsLoaded&&b())||document.observe("xwiki:dom:loaded",b);document.observe("xwiki:dom:updated",b);return c}(XWiki||{}));var PhenoTips=(function(b){var a=b.widgets=b.widgets||{};a.DetailsDialog=Class.create({initialize:function(d,c,e){this._container=e;this._dataName=c;this._elementID=d;this._qualifierMap={};this._buildEmptyDialog()},withNumericSelect:function(o){o=o||{};if(!o.from||!o.to){return this}var l=o.from;var m=o.to;var d=o.step||1;var n=o.majorStepSize||null;var f=o.inputSourceClass||"";var k=new Element("span");var g='<select name="'+this._dataName+'" class="'+f+'"><option value=""></option>';n&&(g+='<option value="<'+l+'">before '+l+"</option>");var c=1;var h=l;for(var e=l;e<=m;e+=d,c++){if(n&&c===n){c=0;g+='<option value="'+h+"-"+e+'">'+h+"-"+e+"</option>";h=e+d}g+='<option value="'+e+'">'+e+"</option>"}n&&(g+='<option value=">'+m+'">after '+m+"</option></select>");k.innerHTML=g;k._getValue=this._defaultGetSelectValueFx(k);k._setValue=this._setSelectValueFx(k,o.storedToDisplayedMapper);k._addValue=this._addSelectValueFx(k,o.qualifierName,o.displayedToStoredMapper);o.inline="inline";return this.withQualifierElement(k,false,o)},withItemSelect:function(d){d=d||{};var g=d.inputSourceClass||"";var f=d.data||[""];var e=new Element("span");var c='<select name="'+this._dataName+'" class="'+g+'">';f.forEach(function(h){c+='<option value="'+h+'">'+h+"</option>"});c+="</select>";e.innerHTML=c;e._getValue=this._defaultGetSelectValueFx(e);e._setValue=this._setSelectValueFx(e,d.storedToDisplayedMapper);e._addValue=this._addSelectValueFx(e,d.qualifierName,d.displayedToStoredMapper);d.inline="inline";return this.withQualifierElement(e,false,d)},withRadioList:function(f,d){d=d||{};var k=this;var h=d.inputSourceClass||"";var g=d.data||[];var e=new Element("span");var c="<ul>";g.forEach(function(m){var l=h+"_"+k._elementID+"_"+m;c+='<li class="term-entry"><input class="'+h+'" id="'+l+'" name="'+k._dataName+"_"+k._elementID+"_"+d.qualifierName+'" title="'+m+'" type="radio"><label for="'+l+'" title="'+m+'">'+m+"</label></li>"});c+="</ul>";e.innerHTML=c;e.down("li.term-entry").down("input").checked=true;e._getValue=this._getRadioValueFx(e,d.qualifierName);e._setValue=this._setRadioValueFx(e,d.storedToDisplayedMapper,f);e._addValue=this._addRadioValueFx(e,d.qualifierName,d.displayedToStoredMapper);return this.withQualifierElement(e,f,d)},withTextBox:function(e,c){var f=c&&c.inputSourceClass||"";var d=new Element("span");d.innerHTML='<textarea class="qualifier-notes '+f+'" name="'+this._dataName+'"></textarea>';d._getValue=this._getTextboxValueFx(d);d._setValue=this._setTextboxValueFx(d,c.storedToDisplayedMapper,e);d._addValue=this._addTextboxValueFx(d,c.qualifierName,c.displayedToStoredMapper);return this.withQualifierElement(d,e,c)},withQualifierElement:function(e,o,p){var m=p.defListItemClass||"";var g=p.qualifierLabel||"";var c=p.qualifierName||"";var d=new Element("dt");var k=new Element("dd");d.addClassName(m);if(p.inline){d.addClassName(p.inline);k.addClassName(p.inline)}k.addClassName(m);var h;if(o){d.addClassName("collapsible");k.addClassName("collapsed");d.insert('<span class="collapse-button">â–º</span>');var n=e.down("li.term-entry");var l=n&&n.down("input");var f=l&&l.title||"";h='<span class="selected-value">'+f+"</span>";k.hide()}d.insert("<label>"+g+"</label>");h&&d.insert(h);k.insert(e);this._attachSummaryFx(e,d,k);this._qualifierList.insert(d).insert(k);c&&(this._qualifierMap[c]=e);return this},withDeleteAction:function(){var c=new Element("span",{id:"delete_"+this._elementID,"class":this._dataName+"-dialog-delete action-done clickable"}).update("âœ–");this._termDetails.insert({top:c});this._attachOnDeleteListener(c);return this},attach:function(){this._container.insert(this._termDetails);return this},getDialog:function(){return this._termDetails},getID:function(){return this._elementID},getValues:function(){var c={};for(var e in this._qualifierMap){if(this._qualifierMap.hasOwnProperty(e)){var d=this._qualifierMap[e];d._addValue(c)}}return c},setValues:function(c){if(!c){return}for(var d in c){if(c.hasOwnProperty(d)){var e=this._qualifierMap[d];if(e){e._setValue(c[d])}}}return this},blur:function(){if(this._termDetails.hasClassName("focused")){this._termDetails.removeClassName("focused");this._termDetails.addClassName("blurred");this._toggleSummarize()}},focus:function(){if(!this._termDetails.hasClassName("focused")){this._termDetails.removeClassName("blurred");this._termDetails.addClassName("focused");this._toggleSummarize()}},_attachSummaryFx:function(c,d,f){var e=this;c._toggleSummarize=function(){var g=f.hasClassName("collapsed");if(f.visible()||(d.visible()&&g)){e._showSummary(d,f,c._getValue())}else{e._showEditable(d,f)}}},_showSummary:function(d,g,f){g.hide();if(f.length>0&&f!=="Unknown"){var e;var c;if(d.hasClassName("collapsible")){d.hide();e='<dt class="'+d.className+' preview">'+d.down("label").innerHTML+"</dt>";d.insert({after:e})}c='<dd class="'+g.className+' preview">'+f+"</dd>";g.insert({after:c})}else{d.hide()}},_showEditable:function(d,f){d.show();f&&!f.hasClassName("collapsed")&&f.show();var e;var c;e=d.next("dt.preview");c=f.next("dd.preview");e&&e.remove();c&&c.remove()},_defaultGetSelectValueFx:function(c){return function(){var d=c.down("select");return d.selectedIndex>=0?d.options[d.selectedIndex].value:""}},_setSelectValueFx:function(c,d){return function(e){c.down("select").value=d?d(e):e}},_addSelectValueFx:function(d,c,e){return function(f){var g=c||null;if(g){f[g]=e?e(d._getValue()):d._getValue()}}},_getRadioValueFx:function(d,c){var e=this;return function(){return d.down('input[name="'+e._dataName+"_"+e._elementID+"_"+c+'"]:checked').title}},_setRadioValueFx:function(c,e,d){var f=this;return function(l){var k=e?e(l):l;var g=c.down('input[title="'+k+'"]');if(!g){return}g.checked=true;var m=g.up("dd");var h=m&&m.previous("dt");if(h){f._updateLabelWithSelection(g,h);d&&f._collapseElem(h,m)}}},_addRadioValueFx:function(d,c,e){return function(f){var g=c||null;if(g){f[g]=e?e(d._getValue()):d._getValue()}}},_getTextboxValueFx:function(c){return function(){return c.down("textarea").value}},_setTextboxValueFx:function(c,e,d){return function(f){c.down("textarea").value=e?e(f):f}},_addTextboxValueFx:function(d,c,e){return function(f){var g=c||null;if(g){f[g]=e?e(d.down("textarea").value):d.down("textarea").value}}},_toggleSummarize:function(){for(var c in this._qualifierMap){if(this._qualifierMap.hasOwnProperty(c)){var d=this._qualifierMap[c];d._toggleSummarize()}}},_buildEmptyDialog:function(){this._termDetails=new Element("div",{"class":"summary-item focused"});this._termDetails.innerHTML='<input type="hidden" value="'+this._elementID+'"><div id="term_details_'+this._elementID+'" class="term-details"><dl></dl><div class="clearfloats"></div></div>';this._qualifierList=this._termDetails.down("dl");this._attachQualifierStateChangeListener()},_attachOnDeleteListener:function(c){var d=this;c.observe("click",function(){d._termDetails.remove();d._qualifierMap={};Event.fire(d._container,d._dataName+":dialog:deleted",{id:d._elementID})})},_attachQualifierStateChangeListener:function(){var c=this;this._termDetails.observe("click",function(e){var d=e.target.up();var f;if(d&&d.hasClassName("collapsible")){f=d.next("dd");f&&c._toggleCollapsed(d,f)}else{if(d&&d.hasClassName("term-entry")){f=d.up("dd");f&&c._updateLabelWithSelection(d.down("input"),f.previous("dt"))}}})},_updateLabelWithSelection:function(c,f){var d=f&&f.down("span.selected-value");if(d){var e=c&&c.title||"";d.update(e);if(e==="Unknown"||e===""){d.removeClassName("selected")}else{d.addClassName("selected")}}},_toggleCollapsed:function(c,d){if(d.hasClassName("collapsed")){this._expandElem(c,d)}else{this._collapseElem(c,d)}},_collapseElem:function(d,e){var c=d.down("span.collapse-button");e.addClassName("collapsed");c.innerHTML="â–º";e.hide()},_expandElem:function(d,e){var c=d.down("span.collapse-button");e.removeClassName("collapsed");c.innerHTML="â–¼";e.show()}});return b}(PhenoTips||{}));var PhenoTips=(function(b){var a=b.widgets=b.widgets||{};a.DetailsDialogGroup=Class.create({initialize:function(c,e){this._dataName=c;this._qualifierNo=0;var d=e||{};this._allowMultiDialogs=d.allowMultiDialogs||false;this._disableTermDelete=d.disableTermDelete||false;this._doneTypingInterval=d.doneTypingInterval||500;this._dialogOptions=[];this._dialogMap={};this._crtFocus=null;this._buildEmptyContainer();this._addDialogDeletedListener();this._addDialogFocusManagers();this._attachKeyUpObserver()},getID:function(){return this._termID},get:function(){return this._qualifiersContainer},withLabel:function(e,d,h){var g=(d&&d.strip())||"";var c=(e&&e.strip())||"";this._termID=g;this._label=c||g;if(this._termID===""){return this}this._qualifiersContainer.id=this._dataName+"_"+this._termID;var f=this._qualifiersContainer.down("span.term-data");var k='<label class="label-field">';k+='<input id="status_'+this._termID+'" class="term-status" name="'+this._dataName+'" type="checkbox"> ';k+=this._label+'</label><input class="term-id" type="hidden" value="'+this._termID+'">';f.innerHTML=k;this._addTooltip(h);this._initButtons();return this},dialogsAddNumericSelect:function(c){var d=function(e){e.withNumericSelect(c)};this._dialogOptions.push(d);return this},dialogsAddItemSelect:function(c){var d=function(e){e.withItemSelect(c)};this._dialogOptions.push(d);return this},dialogsAddRadioList:function(d,c){var e=function(f){f.withRadioList(d,c)};this._dialogOptions.push(e);return this},dialogsAddTextBox:function(e,d){var c=function(f){f.withTextBox(e,d)};this._dialogOptions.push(c);return this},dialogsAddCustomElement:function(d,e,c){var f=function(g){g.withQualifierElement(d,e,c)};this._dialogOptions.push(f);return this},dialogsAddDeleteAction:function(){var c=function(d){d.withDeleteAction()};this._dialogOptions.push(c);return this},clearDialogOptions:function(){this._dialogOptions=[];return this},isAffected:function(){var c=this._qualifiersContainer.down("input.term-status");return c.checked},initAffected:function(c){this.affected(true);this.addDialog(c);this._allowMultiDialogs&&this._addDetailsClickListener()},affected:function(c){var d=this._qualifiersContainer.down("input.term-status");d.checked=c},getValues:function(){var d=[];for(var c in this._dialogMap){if(this._dialogMap.hasOwnProperty(c)){d.push(this._dialogMap[c].getValues())}}return{id:this._termID,label:this._label,affected:this.isAffected(),qualifiers:d}},setValues:function(d){if(!d){return}this._clearDetails();if(d.id!==undefined&&this._termID!==d.id){return}if(d.label!==undefined){var c=d.label&&d.label.strip();this._label!==c&&(this._label=c||this._termID)}if(d.affected&&d.qualifiers&&d.qualifiers.length>0){this.affected(d.affected);this._setQualifiers(d.qualifiers)}},clearDetails:function(){this._clearDetails();Event.fire(this._qualifiersContainer,this._dataName+":term:cleared")},addDialog:function(c){var d=this._addDialog();this._dialogMap[d.getID()]=d;this._applyDialogOptions(d);!this._allowMultiDialogs&&this._removeDetailsClickListener();this._dialogHolder.show();if(!c){Event.fire(this._qualifiersContainer,this._dataName+":dialog:added",{element:d.getDialog()})}return d},size:function(){var c=this._qualifiersContainer.select("div.summary-item");return c?c.length:0},_setQualifiers:function(c){var d=this;c.forEach(function(e){d.addDialog(true).setValues(e).blur()});this._allowMultiDialogs&&this._addDetailsClickListener()},_clearDetails:function(){this._qualifierNo=0;this._dialogHolder.descendants().forEach(function(c){c.stopObserving()});this._dialogMap={};this._dialogHolder.update();this._dialogHolder.hide();this.affected(false);this._removeDetailsClickListener()},_buildEmptyContainer:function(){this._qualifiersContainer=new Element("table",{"class":"summary-group "+this._dataName+"-summary-group"});this._qualifiersContainer.name=this._dataName;this._dialogHolder=new Element("td",{"class":"dialog-holder"});var c=new Element("tbody").insert(new Element("tr",{"class":"term-holder"}).insert(new Element("td").insert(new Element("span",{"class":"term-data"})).insert(new Element("span",{"class":"delete-button-holder"})))).insert(new Element("tr").insert(this._dialogHolder)).insert(new Element("tr").insert(new Element("td",{"class":"add-button-holder"})));this._qualifiersContainer.insert(c);this._dialogHolder.hide()},_addTooltip:function(e){if(!e){return}var c=new Element("span",{"class":"fa fa-info-circle xHelpButton "+e,title:this.getID()});new b.widgets.HelpButton(c);var d=this._qualifiersContainer.down("span.term-data");d.insert(c)},_initButtons:function(){this._addButtonHolder=this._qualifiersContainer.down("td.add-button-holder");this._addDetailsButton=new Element("span",{id:"add_details_"+this._termID,"class":"patient-menu-button patient-details-add"}).update('<i class="fa fa-plus"></i> ...');this._addButtonHolder.insert(this._addDetailsButton);this._deleteButtonHolder=this._qualifiersContainer.down("span.delete-button-holder");if(this._disableTermDelete){this._deleteButtonHolder.hide()}else{this._deleteButton=new Element("span",{id:"delete_term_"+this._termID,"class":"action-done patient-term-delete clickable"}).update("âœ–");this._deleteButtonHolder.insert(this._deleteButton);this._addTermDeleteListener()}this._addButtonHolder.hide();this._addOnTermSelectListener()},_applyDialogOptions:function(c){this._dialogOptions.forEach(function(d){d(c)});return c},_addDialog:function(){var c=this._termID+"_"+this._qualifierNo++;return new b.widgets.DetailsDialog(c,this._dataName,this._dialogHolder).attach()},_addTermDeleteListener:function(){var c=this;this._deleteButton.observe("click",function(){var d=c._qualifiersContainer.down("input.term-id");var e=d&&d.value;c._clearDetails();c._removeTermDeleteListener();c._qualifiersContainer.remove();Event.fire(c._qualifiersContainer,c._dataName+":term:deleted",{id:e})});this._deleteButtonHolder.show()},_removeTermDeleteListener:function(){this._deleteButton.stopObserving("click");this._deleteButtonHolder.hide()},_addOnTermSelectListener:function(){var d=this;var c=this._qualifiersContainer.down("input.term-status");c.observe("click",function(e){e.stopPropagation()});c.observe("change",function(e){e.stop();if(c.checked){d._allowMultiDialogs&&d._addDetailsClickListener();d.addDialog(false)}else{d._removeDetailsClickListener();d.clearDetails()}Event.fire(d._qualifiersContainer,d._dataName+":status:changed",{id:d._termID})})},_addDetailsClickListener:function(){var c=this;this._addDetailsButton.observe("click",function(d){d.stop();c.addDialog(false)});this._addButtonHolder.show()},_removeDetailsClickListener:function(){this._addDetailsButton.stopObserving("click");this._addButtonHolder.hide()},_addDialogDeletedListener:function(){var c=this;this._dialogHolder.observe(c._dataName+":dialog:deleted",function(d){if(!this.down()){d.stop();c.clearDetails()}else{d.memo&&d.memo.id&&(delete c._dialogMap[d.memo.id])}})},_addDialogFocusManagers:function(){var c=this;document.observe(this._dataName+":dialog:added",function(d){var e=d.memo&&d.memo.element;if(!e){return}if(e.up("td.dialog-holder")===c._dialogHolder){if(c._crtFocus){c._blur(c._crtFocus)}c._crtFocus=e;c._focus(c._crtFocus)}else{if(c._crtFocus){c._blur(c._crtFocus);c._crtFocus=null}}});document.observe("click",function(f){var e=f.findElement("td.dialog-holder");if(e===c._dialogHolder){var d=f.findElement("div.summary-item");if(c._crtFocus){if(c._crtFocus!==d){c._blur(c._crtFocus);c._crtFocus=d||null;d&&c._focus(c._crtFocus)}}else{c._crtFocus=d||null;d&&c._focus(c._crtFocus)}}else{if(c._crtFocus&&("term-status"!==f.target.className)){c._blur(c._crtFocus);c._crtFocus=null}}})},_blur:function(d){var e=d.down("input").value;var c=this._dialogMap[e];if(c){c.blur();Event.fire(this._qualifiersContainer,this._dataName+":dialog:blurred")}},_focus:function(d){var e=d.down("input").value;var c=this._dialogMap[e];if(c){c.focus();Event.fire(this._qualifiersContainer,this._dataName+":dialog:focused")}},_attachKeyUpObserver:function(){var e=this;var d;this._dialogHolder.observe("keyup",function(f){clearTimeout(d);d=setTimeout(c.bind(e,f),e._doneTypingInterval)});this._dialogHolder.observe("keydown",function(){clearTimeout(d)});var c=function(f){var g=this;f.target.hasClassName("qualifier-notes")&&Event.fire(g._qualifiersContainer,g._dataName+":notes:updated",{target:f.target})}}});return b}(PhenoTips||{}));(function(){var a=function(b){var c=(b&&b.memo.elements)||[$("body")];c.each(function(d){d.select("input.suggestWorkgroups").each(function(e){if(!e.hasClassName("initialized")){var f={script:XWiki.contextPath+"/rest/principals/suggest?searchUsers=false",noresults:"Group not found"};new XWiki.widgets.UserPicker(e,f);e.addClassName("initialized")}})})};(XWiki.domIsLoaded&&a())||document.observe("xwiki:dom:loaded",a);document.observe("xwiki:dom:updated",a)})();